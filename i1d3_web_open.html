<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>i1Display 3 WebHID 실험실</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .row { display: flex; align-items: center; margin-bottom: 15px; padding: 10px; border-bottom: 1px solid #eee; }
        .row label { width: 150px; font-weight: bold; }
        input[type="text"] { flex-grow: 1; padding: 8px; font-family: monospace; margin-right: 10px; border: 1px solid #ccc; }
        button { padding: 8px 15px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background: #0056b3; }
        button.connect { background: #28a745; width: 100%; margin-bottom: 20px; font-size: 1.1em; }
        #log { background: #1e1e1e; color: #adff2f; padding: 15px; height: 300px; overflow-y: auto; border-radius: 4px; font-family: monospace; font-size: 0.9em; }
        .status { color: #666; font-size: 0.8em; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>i1Display 3 센서 다이렉트 컨트롤러</h2>
    <button id="btn-connect" class="connect">1. 장치 연결 (Connect)</button>

    <div class="status" id="device-status">연결 상태: 장치가 연결되지 않음</div>

    <div class="row">
        <label>1) 초기화 (Init):</label>
        <input type="text" id="cmd-init" value="49 00 00 00 00 00 00 00">
        <button onclick="sendCommand('cmd-init')">전송</button>
    </div>

    <div class="row">
        <label>2) Unlock (OEM):</label>
        <input type="text" id="cmd-unlock" value="4F 45 4D 20 49 44 00 00">
        <button onclick="sendCommand('cmd-unlock')">전송</button>
    </div>

    <div class="row">
        <label>3) Dark Calib:</label>
        <input type="text" id="cmd-dark" value="44 00 00 00 00 00 00 00">
        <button onclick="sendCommand('cmd-dark')">전송</button>
    </div>

    <div class="row">
        <label>4) Color Read:</label>
        <input type="text" id="cmd-read" value="4D 00 00 00 00 00 00 00">
        <button onclick="sendCommand('cmd-read')">전송</button>
    </div>

    <h3>통신 로그 (Raw Data)</h3>
    <div id="log"></div>
</div>

<script>
    let device;
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('device-status');

    // 로그 출력 함수
    function log(msg, isInput = false) {
        const time = new Date().toLocaleTimeString();
        const prefix = isInput ? "<span style='color: #00ffff;'>[RECEIVE]</span> " : "[SEND] ";
        logEl.innerHTML += `<div><small>${time}</small> ${prefix} ${msg}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    // 장치 연결
    document.getElementById('btn-connect').addEventListener('click', async () => {
        try {
            const devices = await navigator.hid.requestDevice({
                filters: [{ vendorId: 0x0765, productId: 0x5020 }] // i1Display 3 정보
            });

            if (devices.length > 0) {
                device = devices[0];
                await device.open();
                statusEl.innerText = `연결 상태: ${device.productName} 연결됨`;
                
                // 장치 응답 리스너 등록
                device.oninputreport = (event) => {
                    const data = new Uint8Array(event.data.buffer);
                    const hex = Array.from(data).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
                    log(hex, true);
                };
                
                log("장치 연결 성공!");
            }
        } catch (err) {
            log("연결 실패: " + err.message);
        }
    });

    // 커맨드 전송 함수
    async function sendCommand(inputId) {
        if (!device) {
            alert("장치를 먼저 연결하세요!");
            return;
        }

        const inputVal = document.getElementById(inputId).value.trim();
        // 공백 제거 후 2글자씩 끊어서 바이트 배열 생성
        const hexArray = inputVal.split(' ').join('').match(/.{1,2}/g);
        
        if (!hexArray) return;

        const bytes = hexArray.map(h => parseInt(h, 16));
        const reportData = new Uint8Array(bytes);

        try {
            // i1Display 3는 보통 reportId 0을 사용 (WebHID에서는 첫 바이트가 reportId가 아니면 0으로 보냄)
            await device.sendReport(0, reportData);
            log(inputVal);
        } catch (err) {
            log("전송 오류: " + err.message);
        }
    }
</script>

</body>
</html>