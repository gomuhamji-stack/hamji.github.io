<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>i1Display 3 Advanced Laboratory (V2)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px; }
        h2 { margin-top: 0; color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        h3 { color: #555; font-size: 1.1em; margin-top: 0; }
        .controls { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
        button { padding: 10px 15px; cursor: pointer; border: none; border-radius: 6px; background: #007bff; color: white; font-weight: bold; font-size: 0.9em; }
        button:hover { background: #0056b3; }
        .btn-green { background: #28a745; }
        .btn-orange { background: #fd7e14; }
        .btn-purple { background: #6f42c1; }
        .btn-red { background: #dc3545; }
        input[type="text"] { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: 'Consolas', monospace; }
        #log { background: #1e1e1e; color: #d4d4d4; padding: 15px; height: 350px; overflow-y: auto; border-radius: 6px; font-family: 'Consolas', monospace; font-size: 12px; }
        .interpretation { color: #ff00ea; font-weight: bold; margin-left: 10px; }
        .result-box { background: #e9ecef; padding: 15px; border-radius: 8px; margin-top: 10px; font-family: monospace; }
        .desc-text { font-size: 0.85em; color: #666; margin-bottom: 10px; line-height: 1.4; }
    </style>
</head>
<body>

<div class="container">
    <h2>i1Display 3 Advanced Lab (WebHID)</h2>
    <button id="btn-connect" class="btn-green" style="width:100%; margin-bottom:20px;">ğŸ”Œ ì¥ì¹˜ ì—°ê²° (Connect)</button>

    <div class="section">
        <h3>[ë‹¨ê³„ 1-2] ìƒíƒœ ë° Unlock</h3>
        <div class="controls">
            <button onclick="sendHex('01 00')">Status í™•ì¸</button>
            <button onclick="sendHex('99 00')">Challenge ìš”ì²­</button>
            <select id="key-type" style="padding:8px;"><option value="OEM">OEM Key</option><option value="RETAIL">Retail Key</option></select>
            <button class="btn-orange" onclick="executeUnlock()">Unlock ì‹¤í–‰</button>
        </div>
    </div>

    <div class="section" style="background: #fdfdfe;">
        <h3>[ë‹¨ê³„ 4] ìƒì„¸ ë””ë²„ê¹… ë° ì•Œë ¤ì§„ ëª…ë ¹ì–´</h3>
        <p class="desc-text">
            â€¢ <b>LED ì œì–´ (21 00):</b> ì¥ì¹˜ì˜ LED ëª¨ë“œ(Flash/Fade), íšŸìˆ˜ ë“±ì„ ì„¤ì •í•©ë‹ˆë‹¤.<br>
            â€¢ <b>ë‚´ë¶€ EEPROM ì½ê¸° (08 00):</b> ì‹œë¦¬ì–¼, í•˜ë“œì›¨ì–´ ë²„ì „ ë“±ì´ ì €ì¥ëœ ë¹„íœ˜ë°œì„± ë©”ëª¨ë¦¬ë¥¼ ì½ìŠµë‹ˆë‹¤.<br>
            â€¢ <b>ì¥ì¹˜ ì •ë³´ í™•ì¸ (00 00):</b> íŒì›¨ì–´ ë²„ì „ ë° ì œì¡° ì¼ì ë¬¸ìì—´ì„ ìš”ì²­í•©ë‹ˆë‹¤.
        </p>
        <div class="controls">
            <input type="text" id="custom-hex" placeholder="ëª…ë ¹ì–´ ì…ë ¥ (ì˜ˆ: 21 01 00 10 80)">
            <button class="btn-purple" onclick="sendHex(document.getElementById('custom-hex').value)">ì „ì†¡</button>
        </div>
        <div class="controls">
            <button onclick="sendHex('21 01 00 10 05')">LED Flash (5ë²ˆ)</button>
            <button onclick="sendHex('08 00 00 40')">ë‚´ë¶€ EEPROM (64byte)</button>
            <button onclick="sendHex('00 00')">ìƒì„¸ ì •ë³´ ìš”ì²­</button>
        </div>
    </div>

    <div class="section" style="background: #fff9db; border: 1px solid #fab005;">
        <h3>[ë‹¨ê³„ 5] ì¸¡ì • ë° Raw ë°ì´í„° ë³€í™˜</h3>
        <p class="desc-text">
            <b>ì¸¡ì • ì›ë¦¬:</b> ì¥ì¹˜ëŠ” ì„¤ì •ëœ ì ë¶„ ì‹œê°„(Integration Time) ë™ì•ˆ ë“¤ì–´ì˜¨ ë¹›ì˜ í„ìŠ¤ ìˆ˜ë¥¼ ì¹´ìš´íŠ¸í•©ë‹ˆë‹¤.<br>
            <b>ë³€í™˜ ê³µì‹:</b> 32ë¹„íŠ¸ ì •ìˆ˜ë¡œ ìˆ˜ì‹ ëœ ê° ì±„ë„ì˜ ì¹´ìš´íŠ¸ ê°’ì„ ì£¼íŒŒìˆ˜(Hz)ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.<br>
            $$Frequency (Hz) = \frac{0.5 \times (ReceivedCount + 0.5)}{IntegrationTime (sec)}$$
        </p>
        <div class="controls">
            <button class="btn-red" onclick="sendHex('01 00 01 00 00 00 00 00')">ì¸¡ì • ì‹¤í–‰ (0.2s ì ë¶„)</button>
        </div>
        <div id="measurement-result" class="result-box">ì¸¡ì • ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>

    <h4>í†µì‹  ë¡œê·¸</h4>
    <div id="log"></div>
</div>

<script>
    let device;
    let lastChallengePacket = null;
    const MASTER_KEYS = { OEM: [0xD49FD4A4 >>> 0, 0x597E35CF >>> 0], RETAIL: [0x61CDD11E >>> 0, 0x9D9C1672 >>> 0] };

    document.getElementById('btn-connect').addEventListener('click', async () => {
        try {
            const devices = await navigator.hid.requestDevice({ filters: [{ vendorId: 0x0765, productId: 0x5020 }] });
            if (devices.length > 0) {
                device = devices[0]; await device.open();
                device.oninputreport = (e) => {
                    const data = new Uint8Array(e.data.buffer);
                    if (data[1] === 0x99) lastChallengePacket = data;
                    if (data[1] === 0x01 && data.length >= 14) parseMeasurement(data);
                    decodeAndLog(data);
                };
            }
        } catch (err) { console.error(err); }
    });

    // ë‹¨ê³„ 5: Raw Count ë³€í™˜ ë¡œì§
    function parseMeasurement(data) {
        // data[2~5]: Red, data[6~9]: Green, data[10~13]: Blue (Little Endian)
        const view = new DataView(data.buffer);
        const rCount = view.getUint32(2, true);
        const gCount = view.getUint32(6, true);
        const bCount = view.getUint32(10, true);

        const intTime = 0.2; // ê¸°ë³¸ê°’ 0.2ì´ˆ ì ìš©
        const toHz = (count) => (0.5 * (count + 0.5)) / intTime;

        document.getElementById('measurement-result').innerHTML = `
            <b>Raw Counts:</b> R=${rCount}, G=${gCount}, B=${bCount}<br>
            <b>Converted Frequency:</b> 
            <span style="color:red">R: ${toHz(rCount).toFixed(2)} Hz</span> | 
            <span style="color:green">G: ${toHz(gCount).toFixed(2)} Hz</span> | 
            <span style="color:blue">B: ${toHz(bCount).toFixed(2)} Hz</span>
        `;
    }

    async function sendHex(hexStr) {
        if (!device) return alert("ì—°ê²° ë¨¼ì €!");
        const bytes = hexStr.replace(/\s+/g, '').match(/.{1,2}/g).map(h => parseInt(h, 16));
        const report = new Uint8Array(64); report.set(bytes);
        await device.sendReport(0, report);
    }

	function executeUnlock() {
		if (!lastReceivedPacket) return alert("Challenge ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
	â€‹
		// 1. í‚¤ ì„ íƒ (ì œê³µí•´ì£¼ì‹  OEM í‚¤ë¥¼ ìš°ì„  ì‹œë„í•˜ì„¸ìš”)
		const keyType = document.getElementById('key-type').value;
		const k = MASTER_KEYS[keyType]; // [0xD49FD4A4, 0x597E35CF]
		const c = lastReceivedPacket;
	â€‹
		// 2. ì±Œë¦°ì§€ ë³µí˜¸í™” (i1d3.c: sc[i] = c[3] ^ c[35 + i])
		let sc = new Uint8Array(8);
		for (let i = 0; i < 8; i++) {
			sc[i] = (c[3] ^ c[35 + i]) & 0xFF;
		}

		// 3. 32ë¹„íŠ¸ Unsigned Integerë¡œ ì¡°í•© (Big Endian ë°©ì‹)
		let ci0 = ((sc[3] << 24) | (sc[0] << 16) | (sc[4] << 8) | sc[6]) >>> 0;
		let ci1 = ((sc[1] << 24) | (sc[7] << 16) | (sc[2] << 8) | sc[5]) >>> 0;

		// 4. ì½”ì–´ ìˆ˜í•™ ì—°ì‚° (i1d3.c ë¡œì§)
		let co = [
			(0 - k[0] - ci1) >>> 0,
			(0 - k[1] - ci0) >>> 0,
			Math.imul(ci1, (0 - k[0]) >>> 0) >>> 0,
			Math.imul(ci0, (0 - k[1]) >>> 0) >>> 0
		];

		let sum = 0;
		for (let b of sc) sum += b;
		const keyBytesSum = (v) => ((v & 0xFF) + ((v >>> 8) & 0xFF) + ((v >>> 16) & 0xFF) + ((v >>> 24) & 0xFF));
		sum += keyBytesSum((0 - k[0]) >>> 0) + keyBytesSum((0 - k[1]) >>> 0);

		let s0 = sum & 0xFF;
		let s1 = (sum >>> 8) & 0xFF;


		// 5. 16ë°”ì´íŠ¸ sr (Response) ìƒì„±
		let sr = new Uint8Array(16);
		sr[0] = ((co[0] >>> 16) & 0xFF) + s0; sr[1] = ((co[2] >>> 8) & 0xFF) - s1;
		sr[2] = (co[3] & 0xFF) + s1;          sr[3] = ((co[1] >>> 16) & 0xFF) + s0;
		sr[4] = ((co[2] >>> 16) & 0xFF) - s1; sr[5] = ((co[3] >>> 16) & 0xFF) - s0;
		sr[6] = ((co[1] >>> 24) & 0xFF) - s0; sr[7] = (co[0] & 0xFF) - s1;
		sr[8] = ((co[3] >>> 8) & 0xFF) + s0;  sr[9] = ((co[2] >>> 24) & 0xFF) - s1;
		sr[10] = ((co[0] >>> 8) & 0xFF) + s0; sr[11] = ((co[1] >>> 8) & 0xFF) - s1;
		sr[12] = (co[1] & 0xFF) + s1;         sr[13] = ((co[3] >>> 24) & 0xFF) + s1;
		sr[14] = (co[2] & 0xFF) + s0;         sr[15] = ((co[0] >>> 24) & 0xFF) - s0;

		// 6. ìµœì¢… íŒ¨í‚· ì¡°ë¦½ (9A 00 ëª…ë ¹ + Index 24 ë°°ì¹˜)
		let report = new Uint8Array(64);
		report[0] = 0x9A;
		report[1] = 0x00;

		// ì‘ë‹µ ì•”í˜¸í™” (i1d3.c: r[24 + i] = c[2] ^ sr[i])
		const xorKeyResp = c[2]; 
		for (let i = 0; i < 16; i++) {
			report[24 + i] = (xorKeyResp ^ sr[i]) & 0xFF;
		}
		device.sendReport(0, report).then(() => {
			console.log("Unlock Packet Sent (Index 24 Offset Applied)");
		});
	}

    function decodeAndLog(data) {
        const hex = Array.from(data).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
        const ascii = Array.from(data).map(b => (b >= 32 && b <= 126) ? String.fromCharCode(b) : ".").join('');
        const logEl = document.getElementById('log');
        logEl.innerHTML += `<div><< ${hex.slice(0, 60)}... <span class="interpretation">${ascii.slice(0, 20)}</span></div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }
</script>

</body>
</html>
