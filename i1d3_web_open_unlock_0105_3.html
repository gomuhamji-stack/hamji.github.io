<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>i1Display 3 Ultimate Laboratory</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f9; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px; }
        h2 { margin-top: 0; color: #007bff; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .controls { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        button { padding: 12px 18px; cursor: pointer; border: none; border-radius: 6px; background: #007bff; color: white; font-weight: bold; }
        button:hover { background: #0056b3; }
        .btn-green { background: #28a745; }
        .btn-orange { background: #fd7e14; }
        .btn-purple { background: #6f42c1; }
        input[type="text"] { flex-grow: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-family: 'Consolas', monospace; }
        #log { background: #1e1e1e; color: #d4d4d4; padding: 15px; height: 400px; overflow-y: auto; border-radius: 6px; font-family: 'Consolas', monospace; font-size: 13px; }
        .log-in { color: #4ec9b0; } 
        .log-out { color: #ce9178; }
        .interpretation { color: #ff00ea; font-weight: bold; margin-left: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>i1Display 3 / ColorMunki Direct Control</h2>
    <button id="btn-connect" class="btn-green" style="width:100%; margin-bottom:15px;">ğŸ”Œ ì¥ì¹˜ ì—°ê²° (Connect - Localhost/HTTPS í•„ìˆ˜)</button>

    <div class="section">
        <strong>[ë‹¨ê³„ 1] ìƒíƒœ í™•ì¸ ë° ì±Œë¦°ì§€ ìš”ì²­</strong>
        <div class="controls">
            <button onclick="sendHex('01 00')">ìƒíƒœ í™•ì¸ (01 00)</button>
            <button onclick="sendHex('99 00')">Challenge ìš”ì²­ (99 00)</button>
        </div>
    </div>

    <div class="section">
        <strong>[ë‹¨ê³„ 2] Unlock ë¦¬ìŠ¤í°ìŠ¤ ì „ì†¡ (Offset 24 ì ìš©)</strong>
        <div class="controls">
            <select id="key-type" style="padding:10px; border-radius:5px;">
                <option value="OEM">ì œê³µëœ OEM Key (D4 9F...)</option>
                <option value="RETAIL">í‘œì¤€ Retail Key (61 CD...)</option>
                <option value="MUNKI">ColorMunki Key (E0 1E...)</option>
            </select>
            <button class="btn-orange" onclick="executeUnlock()">ê³„ì‚° ë° Unlock ì „ì†¡</button>
        </div>
    </div>

    <div class="section">
        <strong>[ë‹¨ê³„ 3] í‘œì¤€ ì¸¡ì • ì‹¤í—˜</strong>
        <div class="controls">
            <button onclick="sendHex('01 00 01 00 00 00 00 00')">ì¸¡ì • ì‹¤í–‰ (01 00 01...)</button>
        </div>
    </div>

    <div class="section" style="background: #f8f9fa; border: 1px dashed #6f42c1;">
        <strong>[ë‹¨ê³„ 4] ììœ  ì»¤ë§¨ë“œ ì‹¤í—˜ (Custom Debug)</strong>
        <div class="controls">
            <input type="text" id="custom-hex" placeholder="ì˜ˆ: 21 00 01 00 00 02 (LED ì œì–´)" value="">
            <button class="btn-purple" onclick="sendHex(document.getElementById('custom-hex').value)">ì»¤ë§¨ë“œ ì „ì†¡</button>
        </div>
        <small style="color: #666;">* ì…ë ¥í•œ Hex ê°’ ë’¤ì—ëŠ” ìë™ìœ¼ë¡œ 00ì´ ì±„ì›Œì ¸ 64ë°”ì´íŠ¸ íŒ¨í‚·ìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.</small>
    </div>

    <h4>í†µì‹  ë¡œê·¸</h4>
    <div id="log"></div>
</div>

<script>
    let device;
    let lastChallengePacket = null;
    const MASTER_KEYS = {
        OEM: [0xD49FD4A4 >>> 0, 0x597E35CF >>> 0],
        RETAIL: [0x61CDD11E >>> 0, 0x9D9C1672 >>> 0],
        MUNKI: [0xE01E6E0A >>> 0, 0x257462DE >>> 0]
    };

    document.getElementById('btn-connect').addEventListener('click', async () => {
        try {
            const devices = await navigator.hid.requestDevice({ filters: [{ vendorId: 0x0765, productId: 0x5020 }] });
            if (devices.length > 0) {
                device = devices[0];
                await device.open();
                document.getElementById('log').innerHTML += `<div style="color:#888;">[SYSTEM] ì¥ì¹˜ ì—°ê²° ì„±ê³µ: ${device.productName}</div>`;
                device.oninputreport = (e) => {
                    const data = new Uint8Array(e.data.buffer);
                    if (data[1] === 0x99) lastChallengePacket = data;
                    decodeAndLog(data);
                };
            }
        } catch (err) { alert("ì—°ê²° ì‹¤íŒ¨: " + err.message + "\në°˜ë“œì‹œ localhost ë˜ëŠ” https í™˜ê²½ì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”."); }
    });

    function decodeAndLog(data) {
        const hex = Array.from(data).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
        let ascii = Array.from(data).map(b => (b >= 32 && b <= 126) ? String.fromCharCode(b) : ".").join('');
        
        let interpretation = "";
        if (ascii.includes("Locked")) interpretation = " [í•´ì„: ì¥ì¹˜ ì ê¹€]";
        if (hex.includes("45 72 72 6F 72")) interpretation = " [í•´ì„: ì—ëŸ¬ ë°œìƒ]";
        if (data[0] === 0x00 && data[1] === 0x9A && (data[2] === 0x77 || data[2] === 0x00)) interpretation = " [í•´ì„: Unlock ì„±ê³µ!]";

        const logEl = document.getElementById('log');
        logEl.innerHTML += `<div style="margin-bottom:5px;"><span class="log-in"><< [RECV]</span> ${hex}<br><small style="color:#aaa;">TXT: ${ascii}</small><span class="interpretation">${interpretation}</span></div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    async function sendHex(hexStr) {
        if (!device) return alert("ì¥ì¹˜ë¥¼ ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”.");
        if (!hexStr.trim()) return;

        const bytes = hexStr.replace(/\s+/g, '').match(/.{1,2}/g).map(h => parseInt(h, 16));
        const report = new Uint8Array(64); // i1D3 í†µì‹ ì€ í•­ìƒ 64ë°”ì´íŠ¸ ê³ ì •
        report.set(bytes);
        
        await device.sendReport(0, report);
        const displayHex = Array.from(report).slice(0, 8).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
        document.getElementById('log').innerHTML += `<div style="color:#ce9178;">[${new Date().toLocaleTimeString()}] >> [SEND] ${displayHex}... (64ë°”ì´íŠ¸ íŒ¨ë”© ì™„ë£Œ)</div>`;
    }

    function executeUnlock() {
        if (!lastChallengePacket) return alert("ë‹¨ê³„ 1ì—ì„œ Challengeë¥¼ ë¨¼ì € ë°›ìœ¼ì„¸ìš”.");
        const keyType = document.getElementById('key-type').value;
        const k = MASTER_KEYS[keyType];
        const c = lastChallengePacket;

        // i1d3.c ë¡œì§: index 3 XOR í‚¤ë¡œ ì±Œë¦°ì§€ ë³µí˜¸í™”
        let sc = new Uint8Array(8);
        for (let i = 0; i < 8; i++) sc[i] = c[3] ^ c[35 + i];

        let ci0 = ((sc[3] << 24) | (sc[0] << 16) | (sc[4] << 8) | sc[6]) >>> 0;
        let ci1 = ((sc[1] << 24) | (sc[7] << 16) | (sc[2] << 8) | sc[5]) >>> 0;

        let co = [(-k[0] - ci1) >>> 0, (-k[1] - ci0) >>> 0, Math.imul(ci1, -k[0]) >>> 0, Math.imul(ci0, -k[1]) >>> 0];

        let sum = 0;
        for (let b of sc) sum += b;
        const keySum = (v) => ((v & 0xff) + ((v >> 8) & 0xff) + ((v >> 16) & 0xff) + ((v >> 24) & 0xff));
        sum += keySum(-k[0] >>> 0) + keySum(-k[1] >>> 0);
        let s0 = sum & 0xff, s1 = (sum >> 8) & 0xff;

        let sr = new Uint8Array(16);
        sr[0] = ((co[0] >> 16) & 0xff) + s0; sr[1] = ((co[2] >> 8) & 0xff) - s1;
        sr[2] = (co[3] & 0xff) + s1; sr[3] = ((co[1] >> 16) & 0xff) + s0;
        sr[4] = ((co[2] >> 16) & 0xff) - s1; sr[5] = ((co[3] >> 16) & 0xff) - s0;
        sr[6] = ((co[1] >> 24) & 0xff) - s0; sr[7] = (co[0] & 0xff) - s1;
        sr[8] = ((co[3] >> 8) & 0xff) + s0; sr[9] = ((co[2] >> 24) & 0xff) - s1;
        sr[10] = ((co[0] >> 8) & 0xff) + s0; sr[11] = ((co[1] >> 8) & 0xff) - s1;
        sr[12] = (co[1] & 0xff) + s1; sr[13] = ((co[3] >> 24) & 0xff) + s1;
        sr[14] = (co[2] & 0xff) + s0; sr[15] = ((co[0] >> 24) & 0xff) - s0;

        let report = new Uint8Array(64);
        report[0] = 0x9A; report[1] = 0x00;
        const xorKey = c[2]; // index 2 XOR í‚¤ë¡œ ì‘ë‹µ ì•”í˜¸í™”
        for (let i = 0; i < 16; i++) { report[24 + i] = xorKey ^ sr[i]; }

        device.sendReport(0, report).then(() => {
            document.getElementById('log').innerHTML += `<div style="color:#fd7e14;">[SYSTEM] Unlock ì „ì†¡ ì‹œë„ (${keyType} í‚¤)</div>`;
        });
    }
</script>
</body>
</html>