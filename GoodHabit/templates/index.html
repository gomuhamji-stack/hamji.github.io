<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>GoodHabit Grid v4.7</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #007bff; --success: #2da44e; --fail: #cf222e; --bg: #f0f2f5; --border: #ccc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 12px; }
        #sidebar { width: 190px; background: #fff; border-right: 1px solid var(--border); padding: 15px; flex-shrink: 0; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; }
        #main-content { flex: 1; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; background: white; position: relative; }
        .sidebar-title { font-size: 14px; font-weight: bold; color: #333; margin-bottom: 5px; text-align: center; }
        .table-container { width: 100%; border: 2px solid #333; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; background: white; }
        th, td { border: 1px solid var(--border); padding: 0; height: 32px; text-align: center; vertical-align: middle; }
        .header-row { height: 140px; background: #f8f9fa; }
        .vertical-th { width: 40px; vertical-align: bottom; padding: 10px 0; }
        .vertical-text-wrapper { writing-mode: vertical-rl; text-orientation: upright; display: inline-block; text-align: left; max-height: 120px; margin: 0 auto; }
        .habit-name-input { border: none; background: transparent; width: 100%; font-weight: bold; font-size: 12px; text-transform: uppercase; outline: none; letter-spacing: 2px; }
        .col-date { width: 45px; font-weight: bold; background: #eee; }
        .col-habit { width: 40px; }
        .col-diary { width: auto; text-align: left; padding-left: 10px; font-weight: bold; }
        .habit-cell { width: 100%; height: 100%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: background 0.1s; }
        .habit-cell.done { background-color: var(--success) !important; color: white; }
        .habit-cell.fail { background-color: #fff0f0; color: var(--fail); font-weight: bold; }
        tr.today { background-color: #fffbe6; }
        .diary-input { width: 100%; height: 100%; border: none; background: transparent; padding: 0 10px; outline: none; }
        #goal-input-container { display: none; background: #fffbe6; padding: 12px; border: 1px solid #ffe58f; margin-bottom: 15px; border-radius: 6px; }
        .mini-cal { width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 10px; }
        .mini-cal td { height: 18px; border: none; padding: 1px; }
        .cal-day-cell { border-radius: 2px; display: block; height: 16px; line-height: 16px; text-align: center; }
        .cal-today { border: 1.5px solid #333 !important; font-weight: bold; }
        .month-item { padding: 6px; cursor: pointer; border-radius: 4px; text-align: center; margin-bottom: 4px; border: 1px solid #eee; }
        .month-item.active { background: var(--primary); color: white; font-weight: bold; }
        
        #toast { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: rgba(0, 0, 0, 0.7); color: white; padding: 12px 25px; 
            border-radius: 8px; display: none; z-index: 9999; font-weight: bold; pointer-events: none; 
        }
    </style>
</head>
<body>

<div id="toast">âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤</div>

<div id="sidebar">
    <div id="sidebar-month-display" class="sidebar-title"></div>
    <div id="mini-calendar-container"></div>
    <div style="width: 100%; height: 160px;"><canvas id="radarChart"></canvas></div>
    <div style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">
        <div style="font-size: 11px; color: #999; margin-bottom: 5px;">HISTORY</div>
        <div id="month-list"></div>
    </div>
</div>

<div id="main-content">
    <div style="display: flex; align-items: baseline; gap: 15px; margin-bottom: 15px; flex-shrink: 0;">
        <h1 id="current-month-title" style="margin:0; font-size: 26px; letter-spacing: -1px;"></h1>
        <div id="display-goal" style="font-size: 15px; color: var(--primary); font-weight: bold; font-style: italic;"></div>
    </div>

    <div id="goal-input-container">
        <span style="font-weight: bold; margin-right: 10px;">ğŸ¯ ì´ë‹¬ì˜ ëª©í‘œ ì„¤ì •</span>
        <input type="text" id="goal-input" style="width: 75%; padding: 6px; border: 1px solid #ccc; border-radius: 4px;" 
               placeholder="ì˜ˆ: ìš´ë™ 10ì¼ ì´ìƒí•˜ê¸°" onchange="updateMonthlyGoal(this.value)" autocomplete="off">
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr class="header-row">
                    <th class="col-date">DAY</th>
                    <th class="vertical-th"><div class="vertical-text-wrapper"><input class="habit-name-input" id="name-h1" onchange="updateHabitName('h1_name', this.value)" autocomplete="off"></div></th>
                    <th class="vertical-th"><div class="vertical-text-wrapper"><input class="habit-name-input" id="name-h2" onchange="updateHabitName('h2_name', this.value)" autocomplete="off"></div></th>
                    <th class="vertical-th"><div class="vertical-text-wrapper"><input class="habit-name-input" id="name-h3" onchange="updateHabitName('h3_name', this.value)" autocomplete="off"></div></th>
                    <th class="col-diary">HIGHLIGHTS</th>
                </tr>
            </thead>
            <tbody id="habit-table-body"></tbody>
        </table>
    </div>

    <div id="report-display-area" style="display:none; margin-top: 10px; padding: 20px; background: #f8f9fa; border: 1px solid #ddd;">
        <h3 style="margin:0 0 10px 0;">ğŸ“ Monthly Reflection</h3>
        <p id="saved-report-content" style="white-space: pre-wrap; line-height: 1.6; font-size: 14px;"></p>
    </div>
</div>

<script>
    let currentMonth = new Date().toISOString().slice(0, 7);
    let habitData = {};
    let settings = {};
    let radarChart = null;
    let isFirstLoad = true; // ìŠ¤í¬ë¡¤ íŠ ë°©ì§€ í”Œë˜ê·¸

    window.onload = async () => {
        await loadMonthList();
        await loadAllData(currentMonth);
    };

    async function loadAllData(yearMonth) {
        const res = await fetch(`/api/get_all_data/${yearMonth}`);
        const data = await res.json();
        habitData = {};
        data.habits.forEach(item => { habitData[item.date] = item; });
        settings = data.settings;
        
        document.getElementById('name-h1').value = settings.h1_name;
        document.getElementById('name-h2').value = settings.h2_name;
        document.getElementById('name-h3').value = settings.h3_name;
        document.getElementById('current-month-title').innerText = yearMonth.replace('-', ' ');
        document.getElementById('sidebar-month-display').innerText = yearMonth.replace('-', '. ');
        document.getElementById('display-goal').innerText = data.goal ? `ëª©í‘œ: ${data.goal}` : "";
        document.getElementById('goal-input').value = data.goal || "";
        
        renderTable(yearMonth);
        updateChart();
        renderMiniCalendar(yearMonth);

        const displayArea = document.getElementById('report-display-area');
        if (data.report) {
            displayArea.style.display = 'block';
            document.getElementById('saved-report-content').innerText = data.report;
        } else {
            displayArea.style.display = 'none';
        }
    }

    async function loadMonthList() {
        const res = await fetch('/api/get_months');
        const months = await res.json();
        if (!months.includes(currentMonth)) months.unshift(currentMonth);
        const list = document.getElementById('month-list');
        list.innerHTML = '';
        months.slice(0, 10).forEach(m => {
            const div = document.createElement('div');
            div.className = `month-item ${m === currentMonth ? 'active' : ''}`;
            div.innerText = m;
            div.onclick = () => { currentMonth = m; isFirstLoad = true; loadAllData(m); };
            list.appendChild(div);
        });
    }

    function renderTable(yearMonth) {
        const tbody = document.getElementById('habit-table-body');
        tbody.innerHTML = '';
        const [year, month] = yearMonth.split('-').map(Number);
        const daysInMonth = new Date(year, month, 0).getDate();
        const todayStr = new Date().toLocaleDateString('sv-SE');

        for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const dayData = habitData[dateStr] || { habit1: 0, habit2: 0, habit3: 0, diary: '' };
            const tr = document.createElement('tr');
            if (dateStr === todayStr) tr.className = 'today';

            tr.innerHTML = `
                <td class="col-date">${d}</td>
                <td class="col-habit"><div id="cell-${dateStr}-1" class="habit-cell ${dayData.habit1==1?'done':dayData.habit1==2?'fail':''}" onclick="toggleHabit('${dateStr}',1)">${dayData.habit1==2?'X':''}</div></td>
                <td class="col-habit"><div id="cell-${dateStr}-2" class="habit-cell ${dayData.habit2==1?'done':dayData.habit2==2?'fail':''}" onclick="toggleHabit('${dateStr}',2)">${dayData.habit2==2?'X':''}</div></td>
                <td class="col-habit"><div id="cell-${dateStr}-3" class="habit-cell ${dayData.habit3==1?'done':dayData.habit3==2?'fail':''}" onclick="toggleHabit('${dateStr}',3)">${dayData.habit3==2?'X':''}</div></td>
                <td class="col-diary"><input type="text" class="diary-input" value="${dayData.diary}" onchange="saveDiary('${dateStr}', this.value)" placeholder="..." autocomplete="off"></td>
            `;
            tbody.appendChild(tr);
            
            // ì²« ë¡œë“œ ì‹œì—ë§Œ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ìŠ¤í¬ë¡¤ ì´ë™
            if (isFirstLoad && dateStr === todayStr) {
                setTimeout(() => {
                    tr.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    isFirstLoad = false;
                }, 100);
            }
        }
    }

    async function toggleHabit(date, num) {
        if (!habitData[date]) habitData[date] = { date, habit1:0, habit2:0, habit3:0, diary:'' };
        
        // ë°ì´í„° ì—…ë°ì´íŠ¸
        habitData[date][`habit${num}`] = (habitData[date][`habit${num}`] + 1) % 3;
        
        // í™”ë©´ ì¦‰ì‹œ ë°˜ì˜ (ì „ì²´ ë¦¬ë¡œë“œ ë°©ì§€)
        const cell = document.getElementById(`cell-${date}-${num}`);
        const val = habitData[date][`habit${num}`];
        cell.className = `habit-cell ${val==1?'done':val==2?'fail':''}`;
        cell.innerText = val==2?'X':'';

        await save(habitData[date]);
        
        // 1ì¼ì— ê¸°ë¡ ì‹œ ëª©í‘œì°½ ë…¸ì¶œ
        if (date.endsWith('-01')) document.getElementById('goal-input-container').style.display = 'block';
        
        updateChart();
        renderMiniCalendar(currentMonth); // ì‚¬ì´ë“œë°” ë‹¬ë ¥ë§Œ ì—…ë°ì´íŠ¸
    }

    async function saveDiary(date, text) {
        if (!habitData[date]) habitData[date] = { date, habit1:0, habit2:0, habit3:0, diary:'' };
        habitData[date].diary = text;
        await save(habitData[date]);
        if (date.endsWith('-01')) document.getElementById('goal-input-container').style.display = 'block';
        updateChart();
    }

    async function save(data) {
        await fetch('/api/save_habit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        showToast();
    }

    async function updateMonthlyGoal(val) {
        await fetch('/api/save_goal', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ year_month: currentMonth, content: val }) });
        document.getElementById('display-goal').innerText = val ? `ëª©í‘œ: ${val}` : "";
        showToast();
    }

    async function updateHabitName(key, value) {
        await fetch('/api/save_setting', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key, value }) });
        showToast();
        updateChart();
    }

    function renderMiniCalendar(yearMonth) {
        const container = document.getElementById('mini-calendar-container');
        const [year, month] = yearMonth.split('-').map(Number);
        const firstDay = new Date(year, month - 1, 1).getDay();
        const daysInMonth = new Date(year, month, 0).getDate();
        const todayStr = new Date().toLocaleDateString('sv-SE');
        let html = '<table class="mini-cal"><tbody><tr>';
        for (let i = 0; i < firstDay; i++) html += '<td></td>';
        for (let d = 1; d <= daysInMonth; d++) {
            if ((firstDay + d - 1) % 7 === 0 && d !== 1) html += '</tr><tr>';
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const dayData = habitData[dateStr] || { habit1:0, habit2:0, habit3:0 };
            const count = (dayData.habit1===1?1:0)+(dayData.habit2===1?1:0)+(dayData.habit3===1?1:0);
            let color = '#ebedf0';
            if (count === 3) color = '#2da44e'; else if (count === 2) color = '#9be9a8'; else if (count === 1) color = '#ffee4a';
            html += `<td><span class="cal-day-cell ${dateStr===todayStr?'cal-today':''}" style="background:${color}">${d}</span></td>`;
        }
        html += '</tr></tbody></table>';
        container.innerHTML = html;
    }

    function updateChart() {
        const values = Object.values(habitData);
        const calc = (num) => (values.filter(v => v[`habit${num}`] === 1).length / 31) * 100;
        const dataSet = [calc(1), calc(2), calc(3), 85, 75];
        const labels = [document.getElementById('name-h1').value, document.getElementById('name-h2').value, document.getElementById('name-h3').value, 'DIARY', 'STABILITY'];
        if (radarChart) {
            radarChart.data.labels = labels; radarChart.data.datasets[0].data = dataSet; radarChart.update();
        } else {
            radarChart = new Chart(document.getElementById('radarChart'), { type: 'radar', data: {
                labels: labels, datasets: [{ data: dataSet, backgroundColor: 'rgba(0,123,255,0.1)', borderColor: '#007bff', borderWidth: 2, pointRadius: 0 }]
            }, options: { responsive: true, maintainAspectRatio: false, scales: { r: { suggestedMin: 0, suggestedMax: 100, ticks: { display: false } } }, plugins: { legend: { display: false } } } });
        }
    }

    function showToast() {
        const t = document.getElementById('toast'); 
        t.style.display = 'block';
        setTimeout(() => { t.style.display = 'none'; }, 800);
    }
</script>
</body>
</html>