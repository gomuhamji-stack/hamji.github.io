<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>GoodHabit Tracker v3.5</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #007bff; --success: #2da44e; --fail: #cf222e; --bg: #f6f8fa; --border: #d0d7de; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; font-size: 12px; }
        
        #sidebar { width: 170px; background: #fff; border-right: 1px solid var(--border); padding: 10px; flex-shrink: 0; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        #main-content { flex: 1; padding: 15px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        
        .card { background: white; border-radius: 6px; border: 1px solid var(--border); padding: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .table-container { width: 100%; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #eee; padding: 3px; text-align: center; height: 26px; }
        th { background: #f8f9fa; font-size: 11px; }
        
        .col-date { width: 45px; } .col-habit { width: 35px; }
        .sat { color: #0099ff; font-weight: bold; } .sun { color: #ff8c00; font-weight: bold; }
        tr.today { background-color: #fffbe6; outline: 1px solid #ffe58f; }

        .habit-box { width: 18px; height: 18px; border: 1px solid var(--border); border-radius: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-size: 10px; }
        .habit-box.done { background: var(--success); color: white; border-color: var(--success); }
        .habit-box.fail { color: var(--fail); font-weight: bold; }

        .diary-input { width: 95%; border: none; padding: 2px; font-size: 12px; outline: none; background: transparent; }
        .habit-name-input { width: 30px; border: none; font-weight: bold; text-align: center; font-size: 10px; background: #f0f0f0; border-radius: 2px; }

        /* ì›”ë§ ì´í‰ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-card { background: white; padding: 25px; border-radius: 12px; width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        #report-text { width: 100%; height: 100px; margin: 15px 0; padding: 10px; border: 1px solid var(--border); border-radius: 6px; resize: none; font-size: 13px; }
        .btn-save { background: var(--primary); color: white; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* í•˜ë‹¨ ì´í‰ í‘œì‹œ ì˜ì—­ */
        #report-display-area { margin-top: 10px; background: #eef6ff; border: 1px solid #cce3ff; display: none; }
        #report-display-area h4 { margin: 0 0 5px 0; color: var(--primary); font-size: 13px; }

        /* ë¯¸ë‹ˆ ë‹¬ë ¥ */
        .mini-cal { width: 100%; border-collapse: collapse; font-size: 10px; }
        .mini-cal th, .mini-cal td { border: none; padding: 1px; height: 18px; width: 14.2%; }
        .cal-day-cell { border-radius: 2px; display: block; width: 100%; height: 100%; line-height: 18px; text-align: center; }
        .cal-today { border: 1.5px solid #333 !important; font-weight: bold; }
        
        .month-item { padding: 5px; cursor: pointer; border-radius: 4px; text-align: center; font-size: 11px; }
        .month-item.active { background: #e7f3ff; color: var(--primary); font-weight: bold; }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 6px 15px; border-radius: 20px; display: none; z-index: 3000; }
    </style>
</head>
<body>

<div id="toast">ì €ì¥ë¨</div>

<div id="modal-overlay">
    <div class="modal-card">
        <h2 style="margin: 0;">ğŸ‰ í•œ ë‹¬ ì™„ë£Œ!</h2>
        <p style="color: #666;">ì´ë²ˆ ë‹¬ì˜ ì„±ì·¨ë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œ ê¸°ë¡í•´ ë³´ì„¸ìš”.</p>
        <textarea id="report-text" placeholder="ì´ë²ˆ ë‹¬ì€ ì–´ë–¤ ì ì´ ì¢‹ì•˜ë‚˜ìš”? ë‹¤ìŒ ë‹¬ì˜ ë‹¤ì§ì€?"></textarea>
        <button class="btn-save" onclick="saveMonthlyReport()">ì´í‰ ì €ì¥í•˜ê³  ë§ˆë¬´ë¦¬</button>
    </div>
</div>

<div id="sidebar">
    <div>
        <h3 style="margin: 0 0 8px 0; font-size: 12px;">ğŸ“ ê¸°ë¡ ì„ íƒ</h3>
        <div id="month-list"></div>
    </div>
    <div>
        <h3 style="margin: 0 0 8px 0; font-size: 12px;">ğŸ“… ì´ë²ˆ ë‹¬ í˜„í™©</h3>
        <div id="mini-calendar-container"></div>
    </div>
    <div style="margin-top: auto;">
        <h3 style="margin: 0 0 5px 0; font-size: 11px; text-align: center; color: #666;">ğŸ“Š ë°¸ëŸ°ìŠ¤</h3>
        <canvas id="radarChart"></canvas>
    </div>
</div>

<div id="main-content">
    <div class="card table-container">
        <h2 id="current-month-title" style="margin: 0 0 10px 0; font-size: 15px;"></h2>
        <table>
            <thead>
                <tr>
                    <th class="col-date">ë‚ ì§œ</th>
                    <th class="col-habit"><input class="habit-name-input" id="name-h1" onchange="updateHabitName('h1_name', this.value)"></th>
                    <th class="col-habit"><input class="habit-name-input" id="name-h2" onchange="updateHabitName('h2_name', this.value)"></th>
                    <th class="col-habit"><input class="habit-name-input" id="name-h3" onchange="updateHabitName('h3_name', this.value)"></th>
                    <th>í•œ ì¤„ ì¼ê¸°</th>
                </tr>
            </thead>
            <tbody id="habit-table-body"></tbody>
        </table>
    </div>

    <div id="report-display-area" class="card">
        <h4>ğŸ“ ì´ë‹¬ì˜ íšŒê³ </h4>
        <p id="saved-report-content" style="margin: 5px 0; line-height: 1.5; font-size: 13px;"></p>
    </div>
</div>

<script>
    let currentMonth = new Date().toISOString().slice(0, 7);
    let habitData = {};
    let settings = {};
    let radarChart = null;

    window.onload = async () => {
        await loadMonthList();
        await loadAllData(currentMonth);
    };

    async function loadAllData(yearMonth) {
        const res = await fetch(`/api/get_all_data/${yearMonth}`);
        const data = await res.json();
        habitData = {};
        data.habits.forEach(item => { habitData[item.date] = item; });
        settings = data.settings;
        
        document.getElementById('name-h1').value = settings.h1_name;
        document.getElementById('name-h2').value = settings.h2_name;
        document.getElementById('name-h3').value = settings.h3_name;
        document.getElementById('current-month-title').innerText = yearMonth.replace('-', 'ë…„ ') + 'ì›”';
        
        renderTable(yearMonth);
        updateChart();
        renderMiniCalendar(yearMonth);

        // ì´í‰ ë¡œë“œ ë° í‘œì‹œ
        const displayArea = document.getElementById('report-display-area');
        if (data.report) {
            displayArea.style.display = 'block';
            document.getElementById('saved-report-content').innerText = data.report;
        } else {
            displayArea.style.display = 'none';
        }
    }

    // ... ê¸°ì¡´ loadMonthList, renderTable ì€ ë™ì¼í•˜ê²Œ ìœ ì§€ ...
    async function loadMonthList() {
        const res = await fetch('/api/get_months');
        const months = await res.json();
        if (!months.includes(currentMonth)) months.unshift(currentMonth);
        const list = document.getElementById('month-list');
        list.innerHTML = '';
        months.forEach(m => {
            const div = document.createElement('div');
            div.className = `month-item ${m === currentMonth ? 'active' : ''}`;
            div.innerText = m.replace('-', '/') + 'ì›”';
            div.onclick = () => { currentMonth = m; loadAllData(m); 
                document.querySelectorAll('.month-item').forEach(el => el.classList.remove('active'));
                div.classList.add('active');
            };
            list.appendChild(div);
        });
    }

    function renderTable(yearMonth) {
        const tbody = document.getElementById('habit-table-body');
        tbody.innerHTML = '';
        const [year, month] = yearMonth.split('-').map(Number);
        const daysInMonth = new Date(year, month, 0).getDate();
        const todayStr = new Date().toLocaleDateString('sv-SE');

        for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const dayData = habitData[dateStr] || { habit1: 0, habit2: 0, habit3: 0, diary: '' };
            const dayOfWeek = new Date(year, month - 1, d).getDay();
            const tr = document.createElement('tr');
            if (dateStr === todayStr) tr.className = 'today';
            const dayClass = dayOfWeek === 6 ? 'sat' : (dayOfWeek === 0 ? 'sun' : '');

            tr.innerHTML = `
                <td class="${dayClass}">${d}</td>
                <td><div class="habit-box ${dayData.habit1==1?'done':dayData.habit1==2?'fail':''}" onclick="toggleHabit('${dateStr}',1)">${dayData.habit1==2?'X':''}</div></td>
                <td><div class="habit-box ${dayData.habit2==1?'done':dayData.habit2==2?'fail':''}" onclick="toggleHabit('${dateStr}',2)">${dayData.habit2==2?'X':''}</div></td>
                <td><div class="habit-box ${dayData.habit3==1?'done':dayData.habit3==2?'fail':''}" onclick="toggleHabit('${dateStr}',3)">${dayData.habit3==2?'X':''}</div></td>
                <td><input type="text" class="diary-input" value="${dayData.diary}" onchange="saveDiary('${dateStr}', this.value)"></td>
            `;
            tbody.appendChild(tr);
            if (dateStr === todayStr) tr.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function renderMiniCalendar(yearMonth) {
        const container = document.getElementById('mini-calendar-container');
        const [year, month] = yearMonth.split('-').map(Number);
        const firstDay = new Date(year, month - 1, 1).getDay();
        const daysInMonth = new Date(year, month, 0).getDate();
        const todayStr = new Date().toLocaleDateString('sv-SE');
        let html = '<table class="mini-cal"><thead><tr><th class="sun">ì¼</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th class="sat">í† </th></tr></thead><tbody><tr>';
        for (let i = 0; i < firstDay; i++) html += '<td></td>';
        for (let d = 1; d <= daysInMonth; d++) {
            if ((firstDay + d - 1) % 7 === 0 && d !== 1) html += '</tr><tr>';
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const dayData = habitData[dateStr] || { habit1: 0, habit2: 0, habit3: 0 };
            const count = (dayData.habit1 === 1 ? 1 : 0) + (dayData.habit2 === 1 ? 1 : 0) + (dayData.habit3 === 1 ? 1 : 0);
            let bgColor = '#ebedf0'; let textColor = '#333';
            if (count === 3) { bgColor = '#2da44e'; textColor = '#fff'; }
            else if (count === 2) { bgColor = '#9be9a8'; textColor = '#000'; }
            else if (count === 1) { bgColor = '#ffee4a'; textColor = '#000'; }
            const todayClass = dateStr === todayStr ? 'cal-today' : '';
            html += `<td><span class="cal-day-cell ${todayClass}" style="background:${bgColor}; color:${textColor};">${d}</span></td>`;
        }
        html += '</tr></tbody></table>';
        container.innerHTML = html;
    }

    // 4. ì›”ë§ ì²´í¬ ë° ëª¨ë‹¬ í‘œì‹œ ë¡œì§
    async function saveDiary(date, text) {
        if (!habitData[date]) habitData[date] = { date, habit1:0, habit2:0, habit3:0, diary:'' };
        habitData[date].diary = text;
        await save(habitData[date]);
        
        // ì˜¤ëŠ˜ì´ ì›”ë§ì¸ì§€ í™•ì¸
        const dateObj = new Date(date);
        const lastDay = new Date(dateObj.getFullYear(), dateObj.getMonth() + 1, 0).getDate();
        if (dateObj.getDate() === lastDay && text.length > 2) {
            document.getElementById('modal-overlay').style.display = 'flex';
        }
        updateChart();
    }

    async function saveMonthlyReport() {
        const content = document.getElementById('report-text').value;
        if (!content) return alert("ì´í‰ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        
        await fetch('/api/save_report', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ year_month: currentMonth, content })
        });
        
        document.getElementById('modal-overlay').style.display = 'none';
        loadAllData(currentMonth); // ì¦‰ì‹œ í•˜ë‹¨ì— í‘œì‹œë˜ë„ë¡ ë¦¬ë¡œë“œ
    }

    // ... ê¸°ì¡´ toggleHabit, save, updateChart ë“±ì€ ë™ì¼ ...
    async function toggleHabit(date, num) {
        if (!habitData[date]) habitData[date] = { date, habit1:0, habit2:0, habit3:0, diary:'' };
        habitData[date][`habit${num}`] = (habitData[date][`habit${num}`] + 1) % 3;
        await save(habitData[date]);
        loadAllData(currentMonth);
    }
    async function save(data) {
        await fetch('/api/save_habit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        showToast();
    }
    function showToast() {
        const t = document.getElementById('toast'); t.style.display = 'block';
        setTimeout(() => { t.style.display = 'none'; }, 800);
    }
    function updateChart() {
        const values = Object.values(habitData);
        const calc = (num) => (values.filter(v => v[`habit${num}`] === 1).length / 31) * 100;
        const dRate = (values.filter(v => v.diary.length > 0).length / 31) * 100;
        const dataSet = [calc(1), calc(2), calc(3), dRate, 75];
        const labels = [document.getElementById('name-h1').value, document.getElementById('name-h2').value, document.getElementById('name-h3').value, 'ì¼ê¸°', 'ì§€ì†ì„±'];
        if (radarChart) {
            radarChart.data.labels = labels; radarChart.data.datasets[0].data = dataSet; radarChart.update();
        } else {
            const ctx = document.getElementById('radarChart');
            radarChart = new Chart(ctx, { type: 'radar', data: {
                labels: labels, datasets: [{ label: 'ë‹¬ì„±ë„', data: dataSet, backgroundColor: 'rgba(0,123,255,0.1)', borderColor: '#007bff', pointRadius: 1 }]
            }, options: { responsive: true, scales: { r: { suggestedMin: 0, suggestedMax: 100, ticks: { display: false } } }, plugins: { legend: { display: false } } } });
        }
    }
</script>
</body>
</html>