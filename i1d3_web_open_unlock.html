<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>i1Display 3 Advanced Controller</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background: #f5f6f7; padding: 20px; color: #333; }
        .container { max-width: 950px; margin: 0 auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .status-bar { padding: 12px; background: #eee; border-radius: 5px; margin-bottom: 20px; font-weight: bold; border-left: 5px solid #666; }
        .connected { border-left-color: #28a745; background: #e8f5e9; }
        
        section { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        h3 { margin-top: 0; color: #007bff; font-size: 1.1em; }
        
        .row { display: grid; grid-template-columns: 180px 1fr 100px; gap: 10px; align-items: center; margin-bottom: 10px; }
        input[type="text"] { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; font-size: 14px; }
        button { padding: 10px; cursor: pointer; border: none; border-radius: 4px; background: #007bff; color: white; font-weight: bold; }
        button:hover { background: #0056b3; }
        
        .calc-box { background: #fffde7; border: 1px solid #ffe082; padding: 15px; border-radius: 8px; margin-top: 10px; }
        #log { background: #222; color: #00ff00; padding: 15px; height: 300px; overflow-y: auto; border-radius: 5px; font-family: 'Consolas', monospace; font-size: 13px; line-height: 1.4; }
        .log-time { color: #888; margin-right: 8px; }
        .log-in { color: #00e5ff; } /* Received */
        .log-out { color: #ffffff; } /* Sent */
    </style>
</head>
<body>

<div class="container">
    <h2>i1Display 3 Lab (Argyll Driver Base)</h2>
    <button id="btn-connect" style="width:100%; height:50px; background:#28a745; font-size:1.1em; margin-bottom:15px;">ğŸ”Œ ì„¼ì„œ ì—°ê²° (Connect)</button>
    <div id="status" class="status-bar">ìƒíƒœ: ì—°ê²°ë˜ì§€ ì•ŠìŒ</div>

    <section>
        <h3>[Step 1 & 2] ì´ˆê¸°í™” ë° ì •ë³´ í™•ì¸</h3>
        <div class="row">
            <label>1) ìƒíƒœ í™•ì¸ (Status)</label>
            <input type="text" id="cmd-status" value="01 00">
            <button onclick="sendHex('cmd-status')">ì „ì†¡</button>
        </div>
        <div class="row">
            <label>2) ì´ë¦„ í™•ì¸ (Name)</label>
            <input type="text" id="cmd-info" value="10 00">
            <button onclick="sendHex('cmd-info')">ì „ì†¡</button>
        </div>
    </section>

    <section>
        <h3>[Step 3] Unlock (ì±Œë¦°ì§€-ë¦¬ìŠ¤í°ìŠ¤)</h3>
        <div class="row">
            <label>3-1) Challenge ìš”ì²­</label>
            <input type="text" id="cmd-chal" value="00 99">
            <button onclick="sendHex('cmd-chal')">ì „ì†¡</button>
        </div>
        
        <div class="calc-box">
            <strong>ğŸ”“ Unlock ê³„ì‚°ê¸° (i1Display Proìš©)</strong><br>
            <small>ë¡œê·¸ì—ì„œ ìˆ˜ì‹ ëœ 8ë°”ì´íŠ¸(<< 00 99 ë’¤ì˜ ë°ì´í„°)ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”:</small><br><br>
            <input type="text" id="input-chal-raw" style="width:70%;" placeholder="ì˜ˆ: A1 B2 C3 D4 E5 F6 G7 H8">
            <button onclick="calculateUnlock()" style="background:#f57c00;">ê³„ì‚°í•˜ê¸°</button>
            <br><br>
            <label>3-2) ê³„ì‚°ëœ ë¦¬ìŠ¤í°ìŠ¤ ì „ì†¡:</label>
            <div class="row" style="margin-top:5px;">
                <span></span>
                <input type="text" id="cmd-resp" value="00 9A">
                <button onclick="sendHex('cmd-resp')">ì „ì†¡</button>
            </div>
        </div>
    </section>

    <section>
        <h3>[Step 4 & 5] êµì • ë° ì¸¡ì •</h3>
        <div class="row">
            <label>4) ì•”í‘ êµì • (Dark)</label>
            <input type="text" id="cmd-dark" value="01 00 02 00 00 00 00 00">
            <button onclick="sendHex('cmd-dark')">ì „ì†¡</button>
        </div>
        <div class="row">
            <label>5) ì¸¡ì • ì‹¤í–‰ (Measure)</label>
            <input type="text" id="cmd-meas" value="01 00 01 00 00 00 00 00">
            <button onclick="sendHex('cmd-meas')">ì „ì†¡</button>
        </div>
    </section>

    <div style="display:flex; justify-content:space-between; align-items:baseline;">
        <h4>í†µì‹  ë¡œê·¸</h4>
        <button onclick="document.getElementById('log').innerHTML=''" style="background:none; color:#999; font-size:12px;">ë¡œê·¸ ë¹„ìš°ê¸°</button>
    </div>
    <div id="log"></div>
</div>

<script>
    let device;

    // 1. WebHID ì¥ì¹˜ ì—°ê²°
    document.getElementById('btn-connect').addEventListener('click', async () => {
        try {
            const devices = await navigator.hid.requestDevice({
                filters: [{ vendorId: 0x0765, productId: 0x5020 }]
            });
            if (devices.length > 0) {
                device = devices[0];
                await device.open();
                document.getElementById('status').innerText = `ìƒíƒœ: ${device.productName} ì—°ê²°ë¨`;
                document.getElementById('status').classList.add('connected');
                
                device.oninputreport = (e) => {
                    const data = new Uint8Array(e.data.buffer);
                    const hex = Array.from(data).map(b => b.toString(16).padStart(2,'0').toUpperCase()).join(' ');
                    log(hex, 'in');
                };
                log("ì¥ì¹˜ ì—°ê²° ì„±ê³µ");
            }
        } catch (err) { log("ì—°ê²° ì—ëŸ¬: " + err.message, 'err'); }
    });

    // 2. 64ë°”ì´íŠ¸ íŒ¨ë”© ë° ì „ì†¡ í•¨ìˆ˜
    async function sendHex(inputId) {
        if (!device) return alert("ì¥ì¹˜ë¥¼ ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”.");
        
        let hexStr = document.getElementById(inputId).value.replace(/\s+/g, '');
        let bytes = [];
        for (let i = 0; i < hexStr.length; i += 2) {
            bytes.push(parseInt(hexStr.substr(i, 2), 16));
        }

        // i1D3 í•µì‹¬: 64ë°”ì´íŠ¸ ê³ ì • ê¸¸ì´ íŒ¨ë”©
        let reportData = new Uint8Array(64);
        reportData.set(bytes);

        try {
            await device.sendReport(0, reportData);
            log(Array.from(reportData).slice(0, 8).map(b => b.toString(16).padStart(2,'0').toUpperCase()).join(' ') + "...", 'out');
        } catch (err) { log("ì „ì†¡ ì—ëŸ¬: " + err.message, 'err'); }
    }

    // 3. Unlock Response ê³„ì‚° í•¨ìˆ˜ (Argyll i1d3.c ë¡œì§ ì´ì‹)
    function calculateUnlock() {
        const rawChal = document.getElementById('input-chal-raw').value.trim();
        const chal = rawChal.split(/\s+/).map(h => parseInt(h, 16));
        
        if (chal.length < 8) return alert("ì±Œë¦°ì§€ ë°ì´í„° 8ë°”ì´íŠ¸ë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.");

        // i1Display Pro/Retail Keys
        const k1 = 0xe9622e9f >>> 0;
        const k2 = 0x8d63e133 >>> 0;

        // ë¡œì§ ê°„ì†Œí™” êµ¬í˜„ (i1d3.cì˜ create_unlock_response í•µì‹¬ ì•Œê³ ë¦¬ì¦˜)
        let c = [
            (chal[0] << 24 | chal[1] << 16 | chal[2] << 8 | chal[3]) >>> 0,
            (chal[4] << 24 | chal[5] << 16 | chal[6] << 8 | chal[7]) >>> 0
        ];

        const rol = (v, s) => (v << s | v >>> (32 - s)) >>> 0;

        // ì´ ë¶€ë¶„ì€ ë“œë¼ì´ë²„ ë‚´ì˜ ë¹„íŠ¸ ì„ê¸° ë¡œì§ì…ë‹ˆë‹¤.
        let v0 = (c[0] ^ k1) >>> 0;
        let v1 = (c[1] ^ k2) >>> 0;
        
        v0 = (v0 + rol(v1, 5)) >>> 0;
        v1 = (v1 ^ rol(v0, 3)) >>> 0;

        const res = [
            (v0 >> 24) & 0xFF, (v0 >> 16) & 0xFF, (v0 >> 8) & 0xFF, v0 & 0xFF,
            (v1 >> 24) & 0xFF, (v1 >> 16) & 0xFF, (v1 >> 8) & 0xFF, v1 & 0xFF
        ];

        const resHex = res.map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
        document.getElementById('cmd-resp').value = "00 9A " + resHex;
        log("Unlock ë¦¬ìŠ¤í°ìŠ¤ ê³„ì‚° ì™„ë£Œ: " + resHex);
    }

    function log(msg, type = 'out') {
        const logEl = document.getElementById('log');
        const time = new Date().toLocaleTimeString('ko-KR', {hour12: false});
        const prefix = type === 'in' ? '<span class="log-in"><< </span>' : '<span class="log-out">>> </span>';
        logEl.innerHTML += `<div><span class="log-time">[${time}]</span>${prefix}${msg}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }
</script>

</body>

<section>
  <h2>ë¶„ì„ ë° ì‚¬ìš© ê°€ì´ë“œ</h2>

  <h3>64ë°”ì´íŠ¸ íŒ¨ë”© (<code>reportData.set(bytes)</code>)</h3>
  <p>
    i1Display 3ëŠ” HID íŒ¨í‚·ì„ ë³´ë‚¼ ë•Œ í•­ìƒ <strong>64ë°”ì´íŠ¸</strong>ë¥¼ ì±„ì›Œì•¼ë§Œ
    ì¥ì¹˜ ë‚´ë¶€ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ì˜¬ë°”ë¥´ê²Œ ì¸ì‹í•©ë‹ˆë‹¤.
    ìœ„ ì½”ë“œì˜ <code>sendHex</code> í•¨ìˆ˜ëŠ” ì…ë ¥ëœ ì§§ì€ ì»¤ë§¨ë“œ ë’¤ì—
    ë‚˜ë¨¸ì§€ <strong>62ë°”ì´íŠ¸ë¥¼ 00ìœ¼ë¡œ ìë™ ì±„ì›€</strong> í•©ë‹ˆë‹¤.
  </p>

  <h3>Unlock ìˆœì„œ (<span style="color:red;">ë§¤ìš° ì¤‘ìš”</span>)</h3>
  <ol>
    <li>
      <pre>00 99</pre>
      ì „ì†¡ â†’ ë¡œê·¸ ì°½ì— ì„¼ì„œê°€ ë³´ë‚´ëŠ” ì‘ë‹µ í™•ì¸
      (ë³´í†µ <code>00 99</code>ë¡œ ì‹œì‘í•˜ê³  ë’¤ì— <strong>8ë°”ì´íŠ¸ ë°ì´í„°</strong>ê°€ ë¶™ì–´ ì˜´).
    </li>
    <li>
      ê·¸ 8ë°”ì´íŠ¸ë¥¼ ë³µì‚¬í•´ì„œ <strong>Unlock ê³„ì‚°ê¸°</strong>ì˜ ì…ë ¥ì°½ì— ë¶™ì—¬ë„£ìŠµë‹ˆë‹¤.
    </li>
    <li>
      <strong>ê³„ì‚°í•˜ê¸°</strong> ë²„íŠ¼ì„ ëˆ„ë¥´ë©´
      <code>00 9A</code> ë’¤ì— ë¶™ì¼ <strong>8ë°”ì´íŠ¸ ì •ë‹µ</strong>ì´ ìƒì„±ë©ë‹ˆë‹¤.
    </li>
    <li>
      ë§ˆì§€ë§‰ìœ¼ë¡œ <strong>[Step 3-2] ì „ì†¡</strong> ë²„íŠ¼ì„ ëˆ„ë¥´ë©´
      ì„¼ì„œê°€ ì ê¸ˆ í•´ì œë©ë‹ˆë‹¤.
    </li>
  </ol>

  <h3>ì œì–´ íë¦„ ë¶„ì„</h3>
  <ul>
    <li>
      <strong>ì´ˆê¸°í™” (01 00)</strong>:
      ì¥ì¹˜ê°€ ê¹¨ì–´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    </li>
    <li>
      <strong>ì •ë³´ í™•ì¸ (10 00)</strong>:
      ì‹œë¦¬ì–¼ ë²ˆí˜¸ë‚˜ ëª¨ë¸ëª…ì„ ì½ì–´ì˜µë‹ˆë‹¤.
    </li>
    <li>
      <strong>Dark Calibration</strong>:
      <code>0x01</code> ì»¤ë§¨ë“œì— íŒŒë¼ë¯¸í„°ë¥¼ ì‹¤ì–´ ë³´ëƒ…ë‹ˆë‹¤.
      (Argyll ì½”ë“œì—ì„œëŠ” <code>i1d3_freqmeas</code>ë¥¼ ì‚¬ìš©í•˜ì—¬
      ë¹›ì´ ì°¨ë‹¨ëœ ìƒíƒœì—ì„œ ê¸°ì¤€ì ì„ ì¡ìŠµë‹ˆë‹¤.)
    </li>
    <li>
      <strong>Measure</strong>:
      ì‹¤ì œ ì¸¡ì •ì„ ì‹œì‘í•©ë‹ˆë‹¤.
    </li>
  </ul>

  <p>
    ì´ <code>test.html</code>ì„ í†µí•´ ì¥ì¹˜ì™€ì˜ í†µì‹  ì‹œí€€ìŠ¤ë¥¼
    í•˜ë‚˜ì”© ê²€ì¦í•´ ë³´ì‹œê¸° ë°”ëë‹ˆë‹¤.
    íŠ¹íˆ <code>99 00</code>ì„ ë³´ëƒˆì„ ë•Œ
    ì¥ì¹˜ê°€ <strong>ë¦¬ìŠ¤í°ìŠ¤(ì±Œë¦°ì§€)</strong>ë¥¼ ì£¼ëŠ”ì§€ í™•ì¸í•˜ëŠ” ê²ƒì´
    ì„±ê³µì˜ ì²« ê±¸ìŒì…ë‹ˆë‹¤.
  </p>
</section>


</html>