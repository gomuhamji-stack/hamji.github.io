<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth CSC Sensor</title>
</head>
<body>
    <h1>Bluetooth CSC Sensor Data</h1>
    <label for="wheelSize">Wheel Circumference (m): </label>
    <input type="number" id="wheelSize" value="2.1" step="0.01">  
    <button onclick="connectCSC()">Connect CSC Sensor</button>
    <p id="speed">Speed: -- km/h</p>
    <p id="cadence">Cadence: --</p>

    <script>
        let lastWheelRevolutions = null;
        let lastWheelEventTime = null;
        
        async function connectCSC() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['cycling_speed_and_cadence']
                });
                
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('cycling_speed_and_cadence');
                const characteristic = await service.getCharacteristic('csc_measurement');
                
                characteristic.addEventListener('characteristicvaluechanged', handleCSCData);
                await characteristic.startNotifications();
                console.log("Connected to CSC Sensor");
            } catch (error) {
                console.error("Error: ", error);
            }
        }

        function handleCSCData(event) {
            const value = event.target.value;
            let speed = "--", cadence = "--";
            
            if (value.byteLength > 1) {
                const flags = value.getUint8(0);
                let index = 1;
                
                if (flags & 0x01) { 
                    const wheelRevolutions = value.getUint32(index, true);
                    const wheelEventTime = value.getUint16(index + 4, true);
                    const wheelSize = parseFloat(document.getElementById("wheelSize").value);
                    
                    if (lastWheelRevolutions !== null) {
                        const revDiff = wheelRevolutions - lastWheelRevolutions;
                        const timeDiff = (wheelEventTime - lastWheelEventTime) / 1024.0;
                        
                        if (timeDiff > 0) {
                            const speedMps = (revDiff * wheelSize) / timeDiff;
                            speed = (speedMps * 3.6).toFixed(2) + " km/h";
                        }
                    }
                    
                    lastWheelRevolutions = wheelRevolutions;
                    lastWheelEventTime = wheelEventTime;
                    index += 6;
                }
                
                if (flags & 0x02) { 
                    const crankRevolutions = value.getUint16(index, true);
                    const lastCrankTime = value.getUint16(index + 2, true);
                    cadence = `${crankRevolutions} revs (${lastCrankTime} ms)`;
                }
            }
            
            document.getElementById("speed").textContent = `Speed: ${speed}`;
            document.getElementById("cadence").textContent = `Cadence: ${cadence}`;
        }
    </script>
</body>
</html>
