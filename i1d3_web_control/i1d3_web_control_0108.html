<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>i1Display 3 Lab - Auto Unlock & XYZ</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background: #f4f7f9; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .status-bar { padding: 15px; background: #eee; border-radius: 6px; margin-bottom: 20px; font-weight: bold; border-left: 5px solid #007bff; }
        .section { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        button { padding: 12px 18px; cursor: pointer; border: none; border-radius: 6px; background: #007bff; color: white; font-weight: bold; transition: 0.3s; }
        button:hover { background: #0056b3; }
        .btn-green { background: #28a745; }
        .btn-orange { background: #fd7e14; }
        #log { background: #1e1e1e; color: #d4d4d4; padding: 15px; height: 500px; overflow-y: auto; border-radius: 6px; font-family: 'Consolas', monospace; font-size: 13px; line-height: 1.6; }
        .log-in { color: #4ec9b0; } 
        .log-out { color: #ce9178; }
        .log-sys { color: #808080; font-style: italic; }
        .interpretation { color: #ff00ea; font-weight: bold; margin-left: 10px; }
        .xyz-val { color: #ffff00; font-weight: bold; background: #333; padding: 2px 5px; border-radius: 3px; }
    </style>
</head>
<body>
<div class="container">
    <h2>i1Display 3 / ColorMunki Direct Control</h2>
    <button id="btn-connect" class="btn-green" style="width:100%; margin-bottom:15px;">ğŸ”Œ ì¥ì¹˜ ì—°ê²° (Connect)</button>
    <div id="status" class="status-bar">ìƒíƒœ: ì—°ê²° ëŒ€ê¸° ì¤‘...</div>

    <div class="section">
        <strong>[ë‹¨ê³„ 1] ì •ë³´ í™•ì¸ ë° ì´ˆê¸°í™”</strong>
        <div class="controls">
            <button class="btn-orange" onclick="runInitSequence()">ìë™ ì´ˆê¸°í™” (ìˆœì°¨ ì‹¤í–‰)</button>
            <button onclick="sendHex('00 20')">ì ê¸ˆ ìƒíƒœ í™•ì¸ (00 20)</button>
        </div>
    </div>

    <div class="section">
        <strong>[ë‹¨ê³„ 2] Unlock (ìë™ í‚¤ ì°¾ê¸° í¬í•¨)</strong>
        <div class="controls">
            <button class="btn-orange" onclick="sendHex('99 00')">1. Challenge ìš”ì²­ (99 00)</button>
            <button class="btn-orange" onclick="executeUnlock()">2. ìˆ˜ë™ Unlock ì „ì†¡ (Key 3)</button>
            <button class="btn-orange" style="background: #e83e8c;" onclick="autoFindUnlock()">3. ì„±ê³µí•  ë•Œê¹Œì§€ í‚¤ë“¤ì„ ì°¾ê¸°</button>
        </div>
        <small style="color: #666;">* 11ê°œì˜ ë§ˆìŠ¤í„° í‚¤ë¥¼ ìˆœì„œëŒ€ë¡œ ëŒ€ì…í•˜ì—¬ '00 9A 77' ì‘ë‹µì„ ì°¾ìŠµë‹ˆë‹¤.</small>
    </div>

    <div class="section">
        <strong>[ë‹¨ê³„ 3] ì¸¡ì • ë° XYZ ì‹¤ì‹œê°„ ë³€í™˜</strong>
        <div class="controls">
            <button onclick="sendHex('04 00 9F 24 00 00 07 E8 03')">AIO ì¸¡ì • (0.2ì´ˆ)</button>
            <button onclick="sendHex('94 00')">ë””í“¨ì € ìœ„ì¹˜ (94 00)</button>
        </div>
    </div>
    <h4>í†µì‹  ë¡œê·¸</h4>
    <div id="log"></div>
</div>

<script>
    let device;
    let lastReceivedPacket = null;
    let isUnlockedSuccess = false;

    // i1d3.c ì†ŒìŠ¤ ì½”ë“œì— ì •ì˜ëœ 11ê°œì˜ ì ê¸ˆ í•´ì œ í‚¤ ë¦¬ìŠ¤íŠ¸
    const I1D3_CODES = [
        { name: "i1Display3 (Retail)", keys: [0xe9622e9f, 0x8d63e133] },
        { name: "Colormunki Display", keys: [0xe01e6e0a, 0x257462de] },
        { name: "i1Display3 (OEM)", keys: [0xcaa62b2c, 0x30815b61] }, // ì‚¬ìš©ì ë¡œê·¸ ì„±ê³µ í‚¤
        { name: "i1Display3 (NEC SSP)", keys: [0xa9119479, 0x5b168761] },
        { name: "i1Display3 (Quato)", keys: [0x160eb6ae, 0x14440e70] },
        { name: "i1Display3 (HP)", keys: [0x291e41d7, 0x51937bdd] },
        { name: "i1Display3 (Wacom)", keys: [0x1abfae03, 0xf25ac8e8] },
        { name: "i1Display3 (TPA)", keys: [0x828c43e9, 0xcbb8a8ed] },
        { name: "i1Display3 (Barco)", keys: [0xe8d1a980, 0xd146f7ad] },
        { name: "i1Display3 (Crysta)", keys: [0x171ae295, 0x2e5c7664] },
        { name: "i1Display3 (Viewsonic)", keys: [0x64d8c546, 0x4b24b4a7] }
    ];

    const MATRIX = [[0.035814, -0.021980, 0.016668], [0.014015, 0.016946, 0.000451], [-0.000407, 0.000830, 0.078830]];

    document.getElementById('btn-connect').addEventListener('click', async () => {
        try {
            const devices = await navigator.hid.requestDevice({ filters: [{ vendorId: 0x0765, productId: 0x5020 }] });
            if (devices.length > 0) {
                device = devices[0];
                await device.open();
                document.getElementById('status').innerText = "ìƒíƒœ: " + device.productName + " ì—°ê²°ë¨";
                device.oninputreport = (e) => {
                    const data = new Uint8Array(e.data.buffer);
                    lastReceivedPacket = data;
                    logResponse(data);
                };
                log("ì¥ì¹˜ ì—°ê²° ì„±ê³µ", "sys");
            }
        } catch (err) { log("Error: " + err.message, "err"); }
    });

    async function runInitSequence() {
        const cmds = ['00 01', '00 10', '00 11', '00 12', '10 00', '00 31', '00 13', '00 20'];
        for (const cmd of cmds) {
            await sendHex(cmd);
            await new Promise(r => setTimeout(r, 200));
        }
    }

    function logResponse(data) {
        const hex = Array.from(data).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
        let ascii = Array.from(data).map(b => (b >= 32 && b <= 126) ? String.fromCharCode(b) : ".").join('');
        let interpretation = "";

        if (data[1] === 0x04) {
            const view = new DataView(data.buffer);
            const rCnt = view.getUint32(2, true), gCnt = view.getUint32(6, true), bCnt = view.getUint32(10, true);
            const rClk = view.getUint32(14, true), gClk = view.getUint32(18, true), bClk = view.getUint32(22, true);
            const toHz = (cnt, clk) => (cnt <= 1) ? 0 : (cnt - 1) * 0.25 / (clk / 48000000);
            const R = toHz(rCnt, rClk), G = toHz(gCnt, gClk), B = toHz(bCnt, bClk);
            const X = (MATRIX[0][0] * R) + (MATRIX[0][1] * G) + (MATRIX[0][2] * B);
            const Y = (MATRIX[1][0] * R) + (MATRIX[1][1] * G) + (MATRIX[1][2] * B);
            const Z = (MATRIX[2][0] * R) + (MATRIX[2][1] * G) + (MATRIX[2][2] * B);
            interpretation = ` <span class="xyz-val">[í•´ì„: X: ${X.toFixed(4)}, Y: ${Y.toFixed(4)}, Z: ${Z.toFixed(4)}]</span>`;
        } else {
            if (data[1] === 0x20) interpretation = ` [í•´ì„: ì¥ì¹˜ ${data[2] === 0 ? 'Unlocked' : 'Locked'}]`;
            if (data[1] === 0x9A && data[2] === 0x77) {
                interpretation = " [í•´ì„: Unlock ì„±ê³µ! (ì½”ë“œ 77 í™•ì¸)]";
                isUnlockedSuccess = true;
            }
        }

        const logEl = document.getElementById('log');
        logEl.innerHTML += `<div style="margin-bottom:5px;"><span class="log-in"><< [RECV]</span> ${hex}<br><small style="color:#aaa;">TXT: ${ascii}</small><span class="interpretation">${interpretation}</span></div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    async function sendHex(hexStr) {
        if (!device) return;
        const bytes = hexStr.replace(/\s+/g, '').match(/.{1,2}/g).map(h => parseInt(h, 16));
        const report = new Uint8Array(64); report.set(bytes);
        await device.sendReport(0, report);
        log(`>> [SEND] ${hexStr}`, "out");
    }

    // sleep ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

    // ìë™ í‚¤ ì°¾ê¸° ë¡œì§
    async function autoFindUnlock() {
        if (!device) return alert("ì¥ì¹˜ë¥¼ ì—°ê²°í•˜ì„¸ìš”.");
        isUnlockedSuccess = false;
        log("ë¬´ì°¨ë³„ ëŒ€ì…(Brute-force) ì ê¸ˆ í•´ì œ ì‹œì‘...", "sys");

        for (let i = 0; i < I1D3_CODES.length; i++) {
            const current = I1D3_CODES[i];
            log(`[ì‹œë„ ${i+1}/11] ${current.name} í‚¤ í…ŒìŠ¤íŠ¸ ì¤‘...`, "sys");
            
            // 1. ë§¤ë²ˆ ìƒˆë¡œìš´ ì±Œë¦°ì§€ ìš”ì²­
            await sendHex('99 00');
            await sleep(400); // ì¥ì¹˜ ì‘ë‹µ ëŒ€ê¸°

            if (!lastReceivedPacket || lastReceivedPacket[1] !== 0x99) {
                log("ì±Œë¦°ì§€ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì¬ì‹œë„ ì¤‘...", "err");
                i--; continue;
            }

            // 2. í˜„ì¬ í‚¤ë¡œ ê³„ì‚°í•˜ì—¬ ì‘ë‹µ ì „ì†¡
            executeUnlock(current.keys);
            await sleep(400); // 9A ì‘ë‹µ ëŒ€ê¸°

            if (isUnlockedSuccess) {
                log(`ì¶•í•˜í•©ë‹ˆë‹¤! ${current.name} í‚¤ë¡œ ì ê¸ˆ í•´ì œì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤.`, "sys");
                break;
            }
        }
        if (!isUnlockedSuccess) log("ëª¨ë“  í‚¤ ëŒ€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í‚¤ ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”.", "err");
    }

    function executeUnlock(overrideKeys = null) {
        if (!lastReceivedPacket || lastReceivedPacket[1] !== 0x99) return alert("Challenge í•„ìš”");
        
        const k = overrideKeys || I1D3_CODES[2].keys; // ê¸°ë³¸ê°’ì€ Key 3
        const c = lastReceivedPacket;

        let sc = new Uint8Array(8);
        for (let i = 0; i < 8; i++) sc[i] = (c[3] ^ c[35 + i]) & 0xFF;

        let ci0 = ((sc[3] << 24) | (sc[0] << 16) | (sc[4] << 8) | sc[6]) >>> 0;
        let ci1 = ((sc[1] << 24) | (sc[7] << 16) | (sc[2] << 8) | sc[5]) >>> 0;

        const negK0 = (~k[0] + 1) >>> 0;
        const negK1 = (~k[1] + 1) >>> 0;

        let co = [(negK0 - ci1) >>> 0, (negK1 - ci0) >>> 0, Math.imul(ci1, negK0) >>> 0, Math.imul(ci0, negK1) >>> 0];

        let sum = 0;
        for (let b of sc) sum += b;
        const kSum = (v) => ((v & 0xFF) + ((v >>> 8) & 0xFF) + ((v >>> 16) & 0xFF) + ((v >>> 24) & 0xFF));
        sum += kSum(negK0) + kSum(negK1);
        let s0 = sum & 0xFF, s1 = (sum >>> 8) & 0xFF;

        let sr = new Uint8Array(16);
        sr[0] = ((co[0] >>> 16) & 0xFF) + s0; sr[1] = ((co[2] >>> 8) & 0xFF) - s1; sr[2] = (co[3] & 0xFF) + s1; sr[3] = ((co[1] >>> 16) & 0xFF) + s0;
        sr[4] = ((co[2] >>> 16) & 0xFF) - s1; sr[5] = ((co[3] >>> 16) & 0xFF) - s0; sr[6] = ((co[1] >>> 24) & 0xFF) - s0; sr[7] = (co[0] & 0xFF) - s1;
        sr[8] = ((co[3] >>> 8) & 0xFF) + s0; sr[9] = ((co[2] >>> 24) & 0xFF) - s1; sr[10] = ((co[0] >>> 8) & 0xFF) + s0; sr[11] = ((co[1] >>> 8) & 0xFF) - s1;
        sr[12] = (co[1] & 0xFF) + s1; sr[13] = ((co[3] >>> 24) & 0xFF) + s1; sr[14] = (co[2] & 0xFF) + s0; sr[15] = ((co[0] >>> 24) & 0xFF) - s0;

        let report = new Uint8Array(64);
        report[0] = 0x9A;
        const xKey = c[2];
        for (let i = 0; i < 16; i++) report[24 + i] = (xKey ^ sr[i]) & 0xFF;

        device.sendReport(0, report).then(() => log(`>> [SEND UNLOCK] 9A 00`, "out"));
    }

    function log(msg, type) {
        const logEl = document.getElementById('log');
        let color = "#808080";
        if (type === "out") color = "#ce9178";
        else if (type === "err") color = "#f44747";
        else if (type === "sys") color = "#4ec9b0";
        logEl.innerHTML += `<div style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }
</script>
</body>
</html>