<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>i1Display 3 Advanced Laboratory</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background: #f4f7f9; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .status-bar { padding: 15px; background: #eee; border-radius: 6px; margin-bottom: 20px; font-weight: bold; border-left: 5px solid #007bff; }
        .section { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
        button { padding: 12px 18px; cursor: pointer; border: none; border-radius: 6px; background: #007bff; color: white; font-weight: bold; }
        button:hover { background: #0056b3; }
        .btn-green { background: #28a745; }
        .btn-orange { background: #fd7e14; }
        #log { background: #1e1e1e; color: #d4d4d4; padding: 15px; height: 450px; overflow-y: auto; border-radius: 6px; font-family: 'Consolas', monospace; font-size: 13px; }
        .log-in { color: #4ec9b0; } 
        .log-out { color: #ce9178; }
        .interpretation { color: #ff00ea; font-weight: bold; margin-left: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>i1Display 3 / ColorMunki Direct Control</h2>
    <button id="btn-connect" class="btn-green" style="width:100%; margin-bottom:15px;">ğŸ”Œ ì¥ì¹˜ ì—°ê²° (Connect)</button>
    <div id="status" class="status-bar">ìƒíƒœ: ì—°ê²° ëŒ€ê¸° ì¤‘...</div>

    <div class="section">
        <strong>[ë‹¨ê³„ 1] ìƒíƒœ í™•ì¸ ë° ì±Œë¦°ì§€ ìš”ì²­</strong>
        <div class="controls">
            <button onclick="sendHex('01 00')">ìƒíƒœ í™•ì¸ (01 00)</button>
            <button onclick="sendHex('99 00')">Challenge ìš”ì²­ (99 00)</button>
            <button onclick="sendHex('10 00')">ì¥ì¹˜ ì •ë³´ (10 00)</button>
        </div>
    </div>

    <div class="section">
        <strong>[ë‹¨ê³„ 2] Unlock ë¦¬ìŠ¤í°ìŠ¤ ê³„ì‚° ë° ì „ì†¡ (Offset 24 ì ìš©)</strong>
        <div class="controls">
            <select id="key-type" style="padding:10px; border-radius:5px;">
                <option value="OEM">ì œê³µëœ OEM Key (D4 9F...)</option>
                <option value="RETAIL">í‘œì¤€ Retail Key (61 CD...)</option>
                <option value="MUNKI">ColorMunki Key (E0 1E...)</option>
            </select>
            <button class="btn-orange" onclick="executeUnlock()">Unlock ê³„ì‚° ë° 16ë°”ì´íŠ¸ ì „ì†¡</button>
        </div>
        <small style="color: #777;">* 99 00 ì‘ë‹µì„ ë°›ì€ ìƒíƒœì—ì„œ ìœ„ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</small>
    </div>

    <div class="section">
        <strong>[ë‹¨ê³„ 3] ì¸¡ì • (ì ê¸ˆ í•´ì œ í›„ ê°€ëŠ¥)</strong>
        <div class="controls">
            <button onclick="sendHex('01 00 01 00 00 00 00 00')">ì¸¡ì • ì‹¤í–‰ (01 00 01...)</button>
        </div>
    </div>

    <h4>í†µì‹  ë¡œê·¸ (í•´ì„ê¸° í¬í•¨)</h4>
    <div id="log"></div>
</div>

<script>
    let device;
    let lastChallengePacket = null;

    // ì •ì˜ëœ ë§ˆìŠ¤í„° í‚¤ ë¦¬ìŠ¤íŠ¸
    const MASTER_KEYS = {
        OEM: [0xD49FD4A4 >>> 0, 0x597E35CF >>> 0],
        RETAIL: [0x61CDD11E >>> 0, 0x9D9C1672 >>> 0],
        MUNKI: [0xE01E6E0A >>> 0, 0x257462DE >>> 0]
    };

    document.getElementById('btn-connect').addEventListener('click', async () => {
        try {
            const devices = await navigator.hid.requestDevice({ filters: [{ vendorId: 0x0765, productId: 0x5020 }] });
            if (devices.length > 0) {
                device = devices[0];
                await device.open();
                document.getElementById('status').innerText = "ìƒíƒœ: " + device.productName + " ì—°ê²°ë¨";
                device.oninputreport = (e) => {
                    const data = new Uint8Array(e.data.buffer);
                    if (data[1] === 0x99) lastChallengePacket = data; 
                    logResponse(data);
                };
            }
        } catch (err) { log("Error: " + err.message, "err"); }
    });

    // ìˆ˜ì‹  ë¡œê·¸ í•´ì„ ë° ì¶œë ¥ í•¨ìˆ˜
    function logResponse(data) {
        const hex = Array.from(data).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
        let ascii = Array.from(data).map(b => (b >= 32 && b <= 126) ? String.fromCharCode(b) : ".").join('');
        
        let interpretation = "";
        // ì£¼ìš” ìƒíƒœ í•´ì„ ë¡œì§ ì¶”ê°€
        if (ascii.includes("Locked")) {
            interpretation = " [í•´ì„: ì¥ì¹˜ ì ê¹€ ìƒíƒœ - Unlockì´ í•„ìš”í•©ë‹ˆë‹¤]";
        } else if (hex.includes("45 72 72 6F 72 3A 20 55 6E 6B 6E 6F 77 6E")) {
            interpretation = " [í•´ì„: ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´ ì—ëŸ¬ - ë°”ì´íŠ¸ ìˆœì„œë¥¼ í™•ì¸í•˜ì„¸ìš”]";
        } else if (data[0] === 0x00 && data[1] === 0x9A) {
            if (data[2] === 0xFA) interpretation = " [í•´ì„: Unlock ì‹¤íŒ¨ - í‚¤ê°’ì´ í‹€ë¦½ë‹ˆë‹¤]";
            else interpretation = " [í•´ì„: Unlock ì„±ê³µ ì‹œë„ ì™„ë£Œ]";
        }

        const logEl = document.getElementById('log');
        logEl.innerHTML += `<div style="margin-bottom:5px;"><span class="log-in"><< [RECV]</span> ${hex}<br><small style="color:#aaa;">TXT: ${ascii}</small><span class="interpretation">${interpretation}</span></div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    async function sendHex(hexStr) {
        if (!device) return alert("ì¥ì¹˜ë¥¼ ì—°ê²°í•˜ì„¸ìš”.");
        const bytes = hexStr.replace(/\s+/g, '').match(/.{1,2}/g).map(h => parseInt(h, 16));
        const report = new Uint8Array(64); // i1D3 64ë°”ì´íŠ¸ íŒ¨ë”© í•„ìˆ˜
        report.set(bytes);
        await device.sendReport(0, report);
        log(`>> [SEND] ${hexStr}`, "out");
    }

    // i1d3.c ë“œë¼ì´ë²„ ë¡œì§ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ì ê¸ˆ í•´ì œ ì‹¤í–‰ í•¨ìˆ˜
    function executeUnlock() {
        if (!lastChallengePacket) return alert("ë¨¼ì € 99 00 ëª…ë ¹ìœ¼ë¡œ ì±Œë¦°ì§€ ë°ì´í„°ë¥¼ ë°›ìœ¼ì„¸ìš”.");

        const keyType = document.getElementById('key-type').value;
        const k = MASTER_KEYS[keyType];
        const c = lastChallengePacket;

        // 1. ì±Œë¦°ì§€ ë³µí˜¸í™” (index 3 XOR í‚¤ ì ìš©)
        let sc = new Uint8Array(8);
        for (let i = 0; i < 8; i++) sc[i] = (c[3] ^ c[35 + i]) & 0xFF; 

        // 2. 32ë¹„íŠ¸ Unsigned ì •ìˆ˜ ì¡°í•©
        let ci0 = ((sc[3] << 24) | (sc[0] << 16) | (sc[4] << 8) | sc[6]) >>> 0;
        let ci1 = ((sc[1] << 24) | (sc[7] << 16) | (sc[2] << 8) | sc[5]) >>> 0;

        // 3. í•µì‹¬ ìˆ˜í•™ ì—°ì‚°
        let co = [
            (0 - k[0] - ci1) >>> 0,
            (0 - k[1] - ci0) >>> 0,
            Math.imul(ci1, (0 - k[0]) >>> 0) >>> 0,
            Math.imul(ci0, (0 - k[1]) >>> 0) >>> 0
        ];

        let sum = 0;
        for (let b of sc) sum += b;
        const keySum = (v) => ((v & 0xff) + ((v >>> 8) & 0xff) + ((v >>> 16) & 0xff) + ((v >>> 24) & 0xff));
        sum += keySum((0 - k[0]) >>> 0) + keySum((0 - k[1]) >>> 0);
        let s0 = sum & 0xff, s1 = (sum >>> 8) & 0xff;

        // 4. 16ë°”ì´íŠ¸ ë¦¬ìŠ¤í°ìŠ¤ ì¡°ë¦½
        let sr = new Uint8Array(16);
        sr[0] = ((co[0] >>> 16) & 0xFF) + s0; sr[1] = ((co[2] >>> 8) & 0xFF) - s1;
        sr[2] = (co[3] & 0xFF) + s1;          sr[3] = ((co[1] >>> 16) & 0xFF) + s0;
        sr[4] = ((co[2] >>> 16) & 0xFF) - s1; sr[5] = ((co[3] >>> 16) & 0xFF) - s0;
        sr[6] = ((co[1] >>> 24) & 0xFF) - s0; sr[7] = (co[0] & 0xFF) - s1;
        sr[8] = ((co[3] >>> 8) & 0xFF) + s0;  sr[9] = ((co[2] >>> 24) & 0xFF) - s1;
        sr[10] = ((co[0] >>> 8) & 0xFF) + s0; sr[11] = ((co[1] >>> 8) & 0xFF) - s1;
        sr[12] = (co[1] & 0xFF) + s1;         sr[13] = ((co[3] >>> 24) & 0xFF) + s1;
        sr[14] = (co[2] & 0xFF) + s0;         sr[15] = ((co[0] >>> 24) & 0xFF) - s0;

        // 5. íŒ¨í‚· ì¡°ë¦½: Index 24ë¶€í„° ë°°ì¹˜ ë° XOR ì•”í˜¸í™”
        let report = new Uint8Array(64);
        report[0] = 0x9A;
        report[1] = 0x00;
        const xorKeyResp = c[2]; // index 2 XOR í‚¤ ì ìš©
        for (let i = 0; i < 16; i++) {
            report[24 + i] = (xorKeyResp ^ sr[i]) & 0xFF; 
        }

        device.sendReport(0, report).then(() => {
            log(`>> [SEND UNLOCK] 9A 00 ... (Offset 24 Applied using ${keyType} Key)`, "out");
        });
    }

    function log(msg, type) {
        const logEl = document.getElementById('log');
        const color = type === "out" ? "#ce9178" : (type === "err" ? "#f44747" : "#808080");
        logEl.innerHTML += `<div style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }
</script>
</body>
</html>