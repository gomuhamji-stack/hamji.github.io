<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>i1Display 3 Lab - Full Integration</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background: #f4f7f9; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .status-bar { padding: 15px; background: #eee; border-radius: 6px; margin-bottom: 20px; font-weight: bold; border-left: 5px solid #007bff; }
        .section { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
        button { padding: 12px 18px; cursor: pointer; border: none; border-radius: 6px; background: #007bff; color: white; font-weight: bold; transition: 0.3s; }
        button:hover { background: #0056b3; }
        .btn-green { background: #28a745; }
        .btn-orange { background: #fd7e14; }
        #log { background: #1e1e1e; color: #d4d4d4; padding: 15px; height: 500px; overflow-y: auto; border-radius: 6px; font-family: 'Consolas', monospace; font-size: 13px; line-height: 1.6; }
        .log-in { color: #4ec9b0; } 
        .log-out { color: #ce9178; }
        .interpretation { color: #ff00ea; font-weight: bold; margin-left: 10px; }
        .xyz-val { color: #ffff00; font-weight: bold; background: #333; padding: 2px 5px; border-radius: 3px; }
    </style>
</head>
<body>
<div class="container">
    <h2>i1Display 3 / ColorMunki Direct Control</h2>
    <button id="btn-connect" class="btn-green" style="width:100%; margin-bottom:15px;">ğŸ”Œ ì¥ì¹˜ ì—°ê²° (Connect)</button>
    <div id="status" class="status-bar">ìƒíƒœ: ì—°ê²° ëŒ€ê¸° ì¤‘...</div>

    <div class="section">
        <strong>[ë‹¨ê³„ 1] ì •ë³´ í™•ì¸ ë° ì´ˆê¸°í™”</strong>
        <div class="controls">
            <button class="btn-orange" onclick="runInitSequence()">ìë™ ì´ˆê¸°í™” (ìˆœì°¨ ì‹¤í–‰)</button>
            <button onclick="sendHex('00 20')">ì ê¸ˆ ìƒíƒœ í™•ì¸ (00 20)</button>
        </div>
    </div>

    <div class="section">
        <strong>[ë‹¨ê³„ 2] Unlock (ë¡œê·¸ ê¸°ë°˜ ì„±ê³µ í‚¤ ì‚¬ìš©)</strong>
        <div class="controls">
            <button class="btn-orange" onclick="sendHex('99 00')">1. Challenge ìš”ì²­ (99 00)</button>
            <button class="btn-orange" onclick="executeUnlock()">2. ì„±ê³µ í‚¤(Key 3)ë¡œ Unlock ì „ì†¡</button>
        </div>
        <small style="color: #666;">* ë¡œê·¸ì—ì„œ ì„±ê³µì´ í™•ì¸ëœ 3ë²ˆì§¸ í‚¤(0xCAA62B2C, 0x30815B61)ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</small>
    </div>

    <div class="section">
        <strong>[ë‹¨ê³„ 3] ì¸¡ì • ë° XYZ ì‹¤ì‹œê°„ ë³€í™˜</strong>
        <div class="controls">
            <button onclick="sendHex('04 00 9F 24 00 00 07 E8 03')">AIO ì¸¡ì • (0.2ì´ˆ)</button>
            <button onclick="sendHex('94 00')">ë””í“¨ì € ìœ„ì¹˜ (94 00)</button>
        </div>
    </div>
    <h4>í†µì‹  ë¡œê·¸</h4>
    <div id="log"></div>
</div>

<script>
    let device;
    let lastReceivedPacket = null;

    // ë¡œê·¸ ë¶„ì„ ê²°ê³¼: 3ë²ˆì§¸ ì‹œë„í•œ í‚¤ê°€ ì„±ê³µí•¨
    // Argyll CMS ì†ŒìŠ¤ ê¸°ë°˜ 3ë²ˆì§¸ í‚¤ ê°’ ì„¸íŒ…
    const K_SUCCESS = [0xCAA62B2C >>> 0, 0x30815B61 >>> 0]; 

    // ì‚¬ìš©ìì˜ ë¡œê·¸ì—ì„œ í™•ì¸ëœ ê³ ìœ  Emissive Matrix
    const MATRIX = [
        [0.035814, -0.021980, 0.016668],
        [0.014015, 0.016946, 0.000451],
        [-0.000407, 0.000830, 0.078830]
    ];

    document.getElementById('btn-connect').addEventListener('click', async () => {
        try {
            const devices = await navigator.hid.requestDevice({ filters: [{ vendorId: 0x0765, productId: 0x5020 }] });
            if (devices.length > 0) {
                device = devices[0];
                await device.open();
                document.getElementById('status').innerText = "ìƒíƒœ: " + device.productName + " ì—°ê²°ë¨";
                device.oninputreport = (e) => {
                    const data = new Uint8Array(e.data.buffer);
                    lastReceivedPacket = data;
                    logResponse(data);
                };
                log("ì¥ì¹˜ ì—°ê²° ì„±ê³µ", "sys");
            }
        } catch (err) { log("Error: " + err.message, "err"); }
    });

    async function runInitSequence() {
        const cmds = ['00 01', '00 10', '00 11', '00 12', '10 00', '00 31', '00 13', '00 20'];
        for (const cmd of cmds) {
            await sendHex(cmd);
            await new Promise(r => setTimeout(r, 200));
        }
    }

    function logResponse(data) {
        const hex = Array.from(data).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
        let ascii = Array.from(data).map(b => (b >= 32 && b <= 126) ? String.fromCharCode(b) : ".").join('');
        let interpretation = "";

        if (data[1] === 0x04) {
            // Little Endian ë°ì´í„° ì¶”ì¶œ
            const view = new DataView(data.buffer);
            const rCnt = view.getUint32(2, true), gCnt = view.getUint32(6, true), bCnt = view.getUint32(10, true);
            const rClk = view.getUint32(14, true), gClk = view.getUint32(18, true), bClk = view.getUint32(22, true);
            
            // Hz ê³„ì‚° (Count - 1) * 0.25 / (Clock / 48MHz)
            const toHz = (cnt, clk) => (cnt <= 1) ? 0 : (cnt - 1) * 0.25 / (clk / 48000000);
            const R = toHz(rCnt, rClk), G = toHz(gCnt, gClk), B = toHz(bCnt, bClk);

            // í–‰ë ¬ ì—°ì‚°ìœ¼ë¡œ XYZ ë„ì¶œ
            const X = (MATRIX[0][0] * R) + (MATRIX[0][1] * G) + (MATRIX[0][2] * B);
            const Y = (MATRIX[1][0] * R) + (MATRIX[1][1] * G) + (MATRIX[1][2] * B);
            const Z = (MATRIX[2][0] * R) + (MATRIX[2][1] * G) + (MATRIX[2][2] * B);

            interpretation = ` <span class="xyz-val">[í•´ì„: XYZ (X: ${X.toFixed(4)}, Y: ${Y.toFixed(4)}, Z: ${Z.toFixed(4)})]</span>`;
        } else {
            if (data[1] === 0x20) interpretation = ` [í•´ì„: ì¥ì¹˜ ${data[2] === 0 ? 'Unlocked (ì—´ë¦¼)' : 'Locked (ì ê¹€)'}]`;
            if (data[0] === 0x00 && data[1] === 0x9A && data[2] === 0x77) interpretation = " [í•´ì„: Unlock ì„±ê³µ!]";
            if (ascii.includes("Locked")) interpretation = " [í•´ì„: ì ê¸ˆ ìƒíƒœë¡œ ì¸í•œ ê±°ë¶€]";
        }

        const logEl = document.getElementById('log');
        logEl.innerHTML += `<div style="margin-bottom:5px;"><span class="log-in"><< [RECV]</span> ${hex}<br><small style="color:#aaa;">TXT: ${ascii}</small><span class="interpretation">${interpretation}</span></div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    async function sendHex(hexStr) {
        if (!device) return alert("ì—°ê²° í•„ìˆ˜");
        const bytes = hexStr.replace(/\s+/g, '').match(/.{1,2}/g).map(h => parseInt(h, 16));
        const report = new Uint8Array(64);
        report.set(bytes);
        await device.sendReport(0, report);
        log(`>> [SEND] ${hexStr}`, "out");
    }

    function executeUnlock() {
        if (!lastReceivedPacket || lastReceivedPacket[1] !== 0x99) return alert("Challenge(99 00) í•„ìš”");
        
        const k = K_SUCCESS; 
        const c = lastReceivedPacket;

        // i1d3.c ì •ë°€ ë³µì œ ì—°ì‚°
        let sc = new Uint8Array(8);
        for (let i = 0; i < 8; i++) sc[i] = (c[3] ^ c[35 + i]) & 0xFF; 

        let ci0 = ((sc[3] << 24) | (sc[0] << 16) | (sc[4] << 8) | sc[6]) >>> 0;
        let ci1 = ((sc[1] << 24) | (sc[7] << 16) | (sc[2] << 8) | sc[5]) >>> 0;

        // Cì–¸ì–´ì˜ 2ì˜ ë³´ìˆ˜ ì—°ì‚°ì„ JavaScript ë¹„íŠ¸ ì—°ì‚°ìœ¼ë¡œ ì¬í˜„ (~v + 1)
        const negK0 = (~k[0] + 1) >>> 0;
        const negK1 = (~k[1] + 1) >>> 0;

        let co = [
            (negK0 - ci1) >>> 0,
            (negK1 - ci0) >>> 0,
            Math.imul(ci1, negK0) >>> 0,
            Math.imul(ci0, negK1) >>> 0
        ];

        let sum = 0;
        for (let b of sc) sum += b;
        const kSum = (v) => ((v & 0xFF) + ((v >>> 8) & 0xFF) + ((v >>> 16) & 0xFF) + ((v >>> 24) & 0xFF));
        sum += kSum(negK0) + kSum(negK1);
        let s0 = sum & 0xFF, s1 = (sum >>> 8) & 0xFF;

        let sr = new Uint8Array(16);
        sr[0] = ((co[0] >>> 16) & 0xFF) + s0; sr[1] = ((co[2] >>> 8) & 0xFF) - s1; sr[2] = (co[3] & 0xFF) + s1; sr[3] = ((co[1] >>> 16) & 0xFF) + s0;
        sr[4] = ((co[2] >>> 16) & 0xFF) - s1; sr[5] = ((co[3] >>> 16) & 0xFF) - s0; sr[6] = ((co[1] >>> 24) & 0xFF) - s0; sr[7] = (co[0] & 0xFF) - s1;
        sr[8] = ((co[3] >>> 8) & 0xFF) + s0; sr[9] = ((co[2] >>> 24) & 0xFF) - s1; sr[10] = ((co[0] >>> 8) & 0xFF) + s0; sr[11] = ((co[1] >>> 8) & 0xFF) - s1;
        sr[12] = (co[1] & 0xFF) + s1; sr[13] = ((co[3] >>> 24) & 0xFF) + s1; sr[14] = (co[2] & 0xFF) + s0; sr[15] = ((co[0] >>> 24) & 0xFF) - s0;

        let report = new Uint8Array(64);
        report[0] = 0x9A;
        const xKey = c[2]; // Response XOR Key
        for (let i = 0; i < 16; i++) {
            report[24 + i] = (xKey ^ sr[i]) & 0xFF; // Offset 24 ì ìš©
        }

        device.sendReport(0, report).then(() => log(`>> [SEND UNLOCK] 9A 00 (Offset 24 Applied)`, "out"));
    }

    function log(msg, type) {
        const logEl = document.getElementById('log');
        const color = type === "out" ? "#ce9178" : (type === "err" ? "#f44747" : (type === "sys" ? "#808080" : "#4ec9b0"));
        logEl.innerHTML += `<div style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }
</script>
</body>
</html>